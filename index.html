<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FACC — First Avenue Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      /* خلفية رئيسية داكنة قريبة من لون الشعار */
      --bg-dark: #022838;
      --bg-dark-soft: #04323b;
      --turquoise-main: #00a7a5;
      --turquoise-soft: #34c7c5;
      --gold-main: #c5a56c;
      --text-main: #f5f7f8;
      --text-muted: #aab8c5;
      --danger: #ff5f5f;
      --warning: #ffc857;
      --success: #24b37a;
      --card-radius: 22px;
      --shadow-soft: 0 22px 40px rgba(0, 0, 0, 0.55);
      --gap-lg: 24px;
      --gap-md: 18px;
      --gap-sm: 12px;
      --transition-fast: 160ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #06414c, #02151b 52%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .page {
      width: 100%;
      max-width: 1440px;
      padding: 18px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: var(--gap-lg);
    }

    /* HEADER */

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap-md);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand-logo-circle {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.45);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .brand-logo-circle img {
      width: 46px;
      height: 46px;
      object-fit: contain;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 20px;
      letter-spacing: 0.13em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #0b8a8d, #14b9b5);
      color: #0a1721;
      box-shadow: var(--shadow-soft);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #16ff9a;
      box-shadow: 0 0 0 5px rgba(22, 255, 154, 0.18);
    }

    /* MAIN GRID */

    .main-grid {
      display: grid;
      grid-template-columns: 2.1fr 1.6fr;
      gap: var(--gap-lg);
      align-items: stretch;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: var(--gap-lg);
    }

    .card {
      background: radial-gradient(circle at top left, #043541, #021c28);
      border-radius: var(--card-radius);
      padding: 16px 18px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--gap-sm);
    }

    .card-title {
      font-size: 15px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .card-badge {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.25);
    }

    .card-badge.success {
      border-color: rgba(36, 179, 122, 0.9);
      color: var(--success);
    }

    .card-badge.warning {
      border-color: rgba(255, 200, 87, 0.9);
      color: var(--warning);
    }

    .card-badge.danger {
      border-color: rgba(255, 95, 95, 0.9);
      color: var(--danger);
    }

    .card-row {
      display: flex;
      gap: var(--gap-md);
      margin-top: 6px;
    }

    .metric-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metric-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 24px;
      font-weight: 600;
    }

    .metric-unit {
      font-size: 13px;
      margin-left: 4px;
      opacity: 0.85;
    }

    .metric-caption {
      font-size: 11px;
      color: var(--text-muted);
    }

    .metric-inline {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 3px;
      color: var(--text-muted);
    }

    .metric-inline span:nth-child(2) {
      font-weight: 500;
      color: var(--text-main);
    }

    /* SPENDING CAP BAR */

    .cap-bar {
      margin-top: 6px;
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      overflow: hidden;
      position: relative;
    }

    .cap-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #26e1c0, #ffd369);
      width: 0%;
      transition: width var(--transition-fast);
    }

    .cap-bar-limit {
      position: absolute;
      top: -4px;
      width: 2px;
      bottom: -4px;
      background: rgba(255, 255, 255, 0.75);
    }

    .cap-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-muted);
    }

    /* CASH FLOW CHART */

    .chart-wrapper {
      margin-top: 8px;
      background: radial-gradient(circle at top left, #063848, #02151f);
      border-radius: 20px;
      padding: 10px 14px 14px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .chart-svg {
      width: 100%;
      height: 180px;
    }

    .chart-axis-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* PROJECTS */

    .projects-section {
      display: flex;
      flex-direction: column;
      gap: var(--gap-md);
    }

    .projects-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--gap-md);
      margin-bottom: 4px;
    }

    .projects-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .projects-title {
      font-size: 14px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .projects-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .projects-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .projects-filter select {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--text-main);
      padding: 5px 10px;
      font-size: 12px;
      outline: none;
    }

    .project-card {
      background: radial-gradient(circle at top left, #033644, #021823);
      border-radius: 18px;
      padding: 10px 14px 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      display: grid;
      grid-template-columns: 2.2fr 1.6fr 1.4fr;
      gap: var(--gap-md);
      align-items: center;
    }

    .project-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .project-name {
      font-size: 15px;
      font-weight: 600;
    }

    .project-stage {
      font-size: 12px;
      color: var(--text-muted);
    }

    .project-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .project-progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }

    .progress-bar-actual {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #21d4a8, #34c7c5);
      width: 0%;
      transition: width var(--transition-fast);
    }

    .progress-bar-planned {
      position: absolute;
      top: 2px;
      bottom: 2px;
      border-radius: inherit;
      border: 2px dashed rgba(255, 255, 255, 0.4);
      width: 0%;
    }

    .project-risks {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .risk-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.35);
    }

    .risk-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .risk-dot.high {
      background: var(--danger);
    }

    .risk-dot.medium {
      background: var(--warning);
    }

    .risk-dot.low {
      background: var(--success);
    }

    .risk-note {
      color: var(--text-muted);
    }

    /* CEO CONTROLS */

    .admin-card {
      background: linear-gradient(120deg, #022633, #011219);
      border-radius: var(--card-radius);
      padding: 14px 18px 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: var(--gap-lg);
      font-size: 12px;
    }

    .admin-title {
      font-size: 13px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .admin-desc {
      color: var(--text-muted);
      line-height: 1.5;
    }

    .admin-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .admin-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admin-row label {
      min-width: 70px;
    }

    .admin-controls select {
      flex: 1;
      background: rgba(0, 0, 0, 0.45);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--text-main);
      padding: 5px 8px;
      outline: none;
      font-size: 12px;
    }

    .admin-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .admin-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .small-footer {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
      text-align: right;
    }

    /* RESPONSIVE */

    @media (max-width: 1100px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .admin-card {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .project-card {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- HEADER -->
    <header class="header">
      <div class="brand">
        <div class="brand-logo-circle">
          <img src="seal.png" alt="FACC Seal" />
        </div>
        <div class="brand-text">
          <div class="brand-title">FACC — COMMAND CENTER</div>
          <div class="brand-subtitle">
            First Avenue for Investment | لوحة قيادة تنفيذية للسيولة والمشاريع والمخاطر
          </div>
        </div>
      </div>
      <div class="header-meta">
        <div class="pill">
          <span class="pill-dot"></span>
          <span>LIVE SNAPSHOT</span>
        </div>
        <div id="last-update-text">Waiting for Google Sheets…</div>
      </div>
    </header>

    <!-- MAIN GRID -->
    <section class="main-grid">
      <!-- LEFT COLUMN: CASH & BUDGET -->
      <div class="col">
        <!-- CASH OVERVIEW -->
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">CASH BALANCE</div>
              <div class="card-subtitle">الرصيد بعد آخر مدفوعات – أعلى من الالتزامات قصيرة الأجل</div>
            </div>
            <span id="cash-status-chip" class="card-badge success">COMFORTABLE</span>
          </div>

          <div class="card-row">
            <div class="metric-block">
              <div class="metric-label">Bank balance</div>
              <div class="metric-value">
                <span id="cash-balance-value">—</span>
                <span class="metric-unit">SAR</span>
              </div>
              <div class="metric-inline">
                <span>Obligations (30D)</span>
                <span id="obligation-30d-text">—</span>
              </div>
              <div class="metric-inline">
                <span>Pending payments</span>
                <span id="pending-payments-text">—</span>
              </div>
            </div>

            <div class="metric-block">
              <div class="metric-label">CONTROL STATUS</div>
              <div class="metric-value" id="control-status-title">—</div>
              <div class="metric-caption" id="control-status-caption">
                Cash comfortably covers 30-day obligations &amp; pending payments.
              </div>
            </div>
          </div>
        </article>

        <!-- BUDGET CONTROL -->
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">BUDGET CONTROL 2026</div>
              <div class="card-subtitle">Approved operating budget &amp; variance (FVI 2026)</div>
            </div>
            <span id="budget-status-chip" class="card-badge success">ON TRACK</span>
          </div>

          <div class="card-row">
            <div class="metric-block">
              <div class="metric-label">Approved budget</div>
              <div class="metric-value">
                <span id="approved-budget-value">—</span>
                <span class="metric-unit">SAR</span>
              </div>
              <div class="metric-inline">
                <span>Actual YTD</span>
                <span id="actual-ytd-text">—</span>
              </div>
            </div>

            <div class="metric-block">
              <div class="metric-label">Budget remaining</div>
              <div class="metric-value">
                <span id="budget-remaining-value">—</span>
                <span class="metric-unit">SAR</span>
              </div>
              <div class="metric-inline">
                <span>Variance %</span>
                <span id="variance-percent-text">—</span>
              </div>
            </div>
          </div>
        </article>

        <!-- MONTHLY SPENDING CAP -->
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">MONTHLY SPENDING CAP</div>
              <div class="card-subtitle">
                سقف الصرف الشهري المقترح (25٪ من الميزانية المتبقية، بحد أقصى 200,000 ريال)
              </div>
            </div>
            <span class="card-badge">AUTO RULE</span>
          </div>

          <div class="card-row">
            <div class="metric-block">
              <div class="metric-label">Safe envelope</div>
              <div class="metric-value">
                <span id="cap-amount-text">—</span>
                <span class="metric-unit">SAR · max monthly</span>
              </div>

              <div class="cap-bar">
                <div id="cap-bar-fill" class="cap-bar-fill"></div>
                <div id="cap-bar-limit" class="cap-bar-limit"></div>
              </div>
              <div class="cap-labels">
                <span>Rule: 25% / remaining months</span>
                <span>Cap limit: 200,000 SAR</span>
              </div>
            </div>

            <div class="metric-block">
              <div class="metric-label">Rule details</div>
              <div class="metric-caption" id="cap-rule-caption">
                Waiting for data…
              </div>
            </div>
          </div>
        </article>

        <!-- CASH FLOW PROJECTION -->
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">CASH FLOW PROJECTION — NEXT 6 MONTHS</div>
              <div class="card-subtitle">
                Based on Income_Forecast &amp; Expense_Forecast من Google Sheets
              </div>
            </div>
          </div>

          <div class="chart-wrapper">
            <svg id="cashflow-chart" class="chart-svg"></svg>
            <div id="cashflow-months" class="chart-axis-labels"></div>
          </div>
        </article>
      </div>

      <!-- RIGHT COLUMN: PROJECTS & CEO CONTROLS -->
      <div class="col">
        <!-- PROJECTS SNAPSHOT -->
        <article class="card projects-section">
          <div class="projects-header-line">
            <div class="projects-title-block">
              <div class="projects-title">PROJECTS SNAPSHOT</div>
              <div class="projects-subtitle">
                مشروعات الجادة الأولى للاستثمار – متابعة مرحلية للمخاطر والتقدم الفعلي
              </div>
            </div>
            <div class="projects-filter">
              <span>Project filter</span>
              <select id="project-filter-select">
                <option value="first-two">First 2 projects</option>
              </select>
            </div>
          </div>

          <div id="projects-slot-a" class="project-card">
            <!-- filled by JS -->
          </div>

          <div id="projects-slot-b" class="project-card">
            <!-- filled by JS -->
          </div>
        </article>

        <!-- CEO CONTROLS -->
        <article class="admin-card">
          <div>
            <div class="admin-title">CEO CONTROLS (ADMIN) — DESKTOP ONLY</div>
            <div class="admin-desc">
              من هذه المنطقة يختار الرئيس التنفيذي أي مشروعين يظهران في
              <strong>Slot A</strong> و <strong>Slot B</strong> في لوحة القيادة.
              تُقرأ بيانات المشاريع من تبويب
              <strong>Projects</strong> في Google Sheets.
              أي تعديل حقيقي على البيانات يتم في الشيت مباشرة، وهذه النسخة V1
              للعرض فقط (Read-only).
            </div>
            <div class="admin-hint">
              <span class="admin-badge">LOCAL ONLY</span>
              &nbsp;اختياراتك هنا لا تعدّل الشيت، لكنها تُحدّث العرض الحالي
              فوريًا. في النسخة القادمة يمكن إضافة تكامل API ليتم التحديث آليًا.
            </div>
          </div>
          <div class="admin-controls">
            <div class="admin-row">
              <label for="slot-a-select">Slot A</label>
              <select id="slot-a-select"></select>
            </div>
            <div class="admin-row">
              <label for="slot-b-select">Slot B</label>
              <select id="slot-b-select"></select>
            </div>
            <div class="admin-hint">
              Tip: اختر مشروعين مختلفين لزاويتي العرض؛ التغييرات تُحفظ في
              المتصفح نفسه (Local view).
            </div>
          </div>
        </article>

        <div class="small-footer">
          FACC – First Avenue Command Center · Internal CEO View · v1.0
        </div>
      </div>
    </section>
  </div>

  <script>
    // === CONFIG: Google Sheets CSV URLs (من الروابط التي أرسلتها) ===
    const DATA1_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=0&single=true&output=csv";
    const PROJECTS_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=146585938&single=true&output=csv";

    // === HELPERS ===
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(",").map((h) => h.trim());
      return lines.slice(1).map((line) => {
        const cells = line.split(",").map((c) => c.trim());
        const obj = {};
        headers.forEach((h, i) => (obj[h] = cells[i] ?? ""));
        return obj;
      });
    }

    function formatSar(num) {
      if (isNaN(num)) return "—";
      return Math.round(num)
        .toLocaleString("en-US")
        .replace(/,/g, ",");
    }

    function toNumber(v) {
      if (v === undefined || v === null || v === "") return 0;
      const n = parseFloat(String(v).replace(/,/g, ""));
      return isNaN(n) ? 0 : n;
    }

    function percent(num) {
      if (isNaN(num)) return "—";
      return num.toFixed(1).replace(/\.0$/, "") + " %";
    }

    // === DOM REFS ===
    const lastUpdateText = document.getElementById("last-update-text");

    const cashBalanceEl = document.getElementById("cash-balance-value");
    const obligationTextEl = document.getElementById("obligation-30d-text");
    const pendingTextEl = document.getElementById("pending-payments-text");
    const cashStatusChip = document.getElementById("cash-status-chip");
    const controlStatusTitle = document.getElementById("control-status-title");
    const controlStatusCaption = document.getElementById(
      "control-status-caption"
    );

    const approvedBudgetEl = document.getElementById("approved-budget-value");
    const actualYtdEl = document.getElementById("actual-ytd-text");
    const budgetRemainingEl = document.getElementById(
      "budget-remaining-value"
    );
    const variancePercentEl = document.getElementById("variance-percent-text");
    const budgetStatusChip = document.getElementById("budget-status-chip");

    const capAmountEl = document.getElementById("cap-amount-text");
    const capRuleCaptionEl = document.getElementById("cap-rule-caption");
    const capBarFill = document.getElementById("cap-bar-fill");
    const capBarLimit = document.getElementById("cap-bar-limit");

    const chartSvg = document.getElementById("cashflow-chart");
    const chartMonthsEl = document.getElementById("cashflow-months");

    const projectsSlotA = document.getElementById("projects-slot-a");
    const projectsSlotB = document.getElementById("projects-slot-b");
    const projectFilterSelect = document.getElementById("project-filter-select");
    const slotASelect = document.getElementById("slot-a-select");
    const slotBSelect = document.getElementById("slot-b-select");

    let projectsData = [];

    // === CASH & BUDGET ===
    function updateCashAndBudget(latestRow, allRows) {
      const cashBalance = toNumber(latestRow.Cash_Balance);
      const pending = toNumber(latestRow.Pending_Payments);
      const obligation30 = toNumber(latestRow.Obligation_30D);
      const approvedBudget = toNumber(latestRow.Budget_Total);

      // Actual YTD = sum Actual_Expense
      const actualYtd = allRows.reduce(
        (sum, r) => sum + toNumber(r.Actual_Expense),
        0
      );
      const budgetRemaining = Math.max(approvedBudget - actualYtd, 0);
      const variancePct =
        approvedBudget > 0 ? (budgetRemaining / approvedBudget) * 100 : 0;

      cashBalanceEl.textContent = formatSar(cashBalance);
      obligationTextEl.textContent = `${formatSar(obligation30)} SAR`;
      pendingTextEl.textContent = `${formatSar(pending)} SAR`;

      approvedBudgetEl.textContent = formatSar(approvedBudget);
      actualYtdEl.textContent = `${formatSar(actualYtd)} SAR`;
      budgetRemainingEl.textContent = formatSar(budgetRemaining);
      variancePercentEl.textContent = percent(variancePct);

      // Cash status
      const shortTermNeeds = obligation30 + pending;
      if (cashBalance >= shortTermNeeds * 1.3) {
        cashStatusChip.textContent = "COMFORTABLE";
        cashStatusChip.classList.remove("warning", "danger");
        cashStatusChip.classList.add("success");
        controlStatusTitle.textContent = "Healthy";
        controlStatusCaption.textContent =
          "Cash is significantly above 30-day obligations and pending payments.";
      } else if (cashBalance >= shortTermNeeds) {
        cashStatusChip.textContent = "TIGHT";
        cashStatusChip.classList.remove("success", "danger");
        cashStatusChip.classList.add("warning");
        controlStatusTitle.textContent = "Tight but OK";
        controlStatusCaption.textContent =
          "Cash roughly covers 30-day obligations and pending amounts.";
      } else {
        cashStatusChip.textContent = "CRITICAL";
        cashStatusChip.classList.remove("success", "warning");
        cashStatusChip.classList.add("danger");
        controlStatusTitle.textContent = "Attention needed";
        controlStatusCaption.textContent =
          "Cash does not fully cover short-term obligations and pending payments.";
      }

      // Budget status
      if (variancePct >= 40) {
        budgetStatusChip.textContent = "UNDER CONTROL";
        budgetStatusChip.classList.remove("warning", "danger");
        budgetStatusChip.classList.add("success");
      } else if (variancePct >= 15) {
        budgetStatusChip.textContent = "WATCH";
        budgetStatusChip.classList.remove("success", "danger");
        budgetStatusChip.classList.add("warning");
      } else {
        budgetStatusChip.textContent = "AT RISK";
        budgetStatusChip.classList.remove("success", "warning");
        budgetStatusChip.classList.add("danger");
      }

      updateCap(budgetRemaining, actualYtd, approvedBudget, allRows);
    }

    // === MONTHLY CAP ===
    function updateCap(budgetRemaining, actualYtd, approvedBudget, rows) {
      const monthsWithBudget = rows.filter(
        (r) => toNumber(r.Income_Forcast) !== 0 || toNumber(r.Expense_Forcast) !== 0
      ).length;
      const remainingMonths = Math.max(monthsWithBudget, 1);

      const rawCap = (budgetRemaining * 0.25) / remainingMonths;
      const cap = Math.min(rawCap, 200000);
      const capRatio =
        approvedBudget > 0 ? (cap / (approvedBudget / remainingMonths)) : 0;

      capAmountEl.textContent = formatSar(cap);
      capRuleCaptionEl.textContent =
        `Suggested cap = min(25% of remaining budget ÷ remaining months, 200,000 SAR). ` +
        `Remaining budget: ${formatSar(budgetRemaining)} SAR over about ${remainingMonths} months.`;

      const widthPercent = Math.max(Math.min(capRatio * 100, 100), 5);
      capBarFill.style.width = widthPercent + "%";
      capBarLimit.style.left = "80%";
    }

    // === CASH FLOW CHART ===
    function updateCashFlowChart(rows) {
      // Use first 6 rows with forecast
      const data = rows.slice(0, 6).map((r) => {
        const inc = toNumber(r.Income_Forcast);
        const exp = toNumber(r.Expense_Forcast);
        return {
          month: r.Month || "",
          inc,
          exp,
          net: inc - exp,
        };
      });

      // Clear SVG
      chartSvg.innerHTML = "";

      if (!data.length) return;

      const width = chartSvg.clientWidth || 600;
      const height = chartSvg.clientHeight || 180;
      const paddingX = 32;
      const paddingTop = 20;
      const paddingBottom = 30;

      const maxNet = Math.max(...data.map((d) => d.net), 0);
      const minNet = Math.min(...data.map((d) => d.net), 0);
      const range = maxNet - minNet || 1;

      const xStep =
        data.length > 1
          ? (width - paddingX * 2) / (data.length - 1)
          : width / 2;

      const points = data.map((d, i) => {
        const x = paddingX + i * xStep;
        const y =
          height -
          paddingBottom -
          ((d.net - minNet) / range) * (height - paddingTop - paddingBottom);
        return { ...d, x, y };
      });

      // Polyline path
      const pathD = points
        .map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`))
        .join(" ");

      const path = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "path"
      );
      path.setAttribute("d", pathD);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "#3fe0c4");
      path.setAttribute("stroke-width", "2.5");
      path.setAttribute("stroke-linecap", "round");
      chartSvg.appendChild(path);

      // Dashed baseline (0)
      if (minNet < 0 && maxNet > 0) {
        const zeroY =
          height -
          paddingBottom -
          ((0 - minNet) / range) * (height - paddingTop - paddingBottom);
        const baseLine = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "line"
        );
        baseLine.setAttribute("x1", paddingX);
        baseLine.setAttribute("x2", width - paddingX);
        baseLine.setAttribute("y1", zeroY);
        baseLine.setAttribute("y2", zeroY);
        baseLine.setAttribute("stroke", "rgba(255,255,255,0.35)");
        baseLine.setAttribute("stroke-width", "1");
        baseLine.setAttribute("stroke-dasharray", "4 4");
        chartSvg.appendChild(baseLine);
      }

      // Points + labels
      points.forEach((p) => {
        const circle = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle"
        );
        circle.setAttribute("cx", p.x);
        circle.setAttribute("cy", p.y);
        circle.setAttribute("r", "4");
        circle.setAttribute("fill", "#3fe0c4");
        chartSvg.appendChild(circle);

        const label = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text"
        );
        label.setAttribute("x", p.x);
        label.setAttribute("y", p.y - 8);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("fill", "#cdeff3");
        label.setAttribute("font-size", "10");
        label.textContent = formatSar(p.net);
        chartSvg.appendChild(label);
      });

      // Months labels
      chartMonthsEl.innerHTML = "";
      data.forEach((d) => {
        const span = document.createElement("span");
        span.textContent = d.month || "";
        chartMonthsEl.appendChild(span);
      });
    }

    // === PROJECTS ===
    function buildProjectOptions() {
      projectFilterSelect.innerHTML =
        '<option value="first-two">First 2 projects</option>';

      slotASelect.innerHTML = "";
      slotBSelect.innerHTML = "";

      projectsData.forEach((p, idx) => {
        const label = `${p.Project_ID || idx + 1} — ${p.Project_Name || "Project"}`;

        const optFilter = document.createElement("option");
        optFilter.value = String(idx);
        optFilter.textContent = label;
        projectFilterSelect.appendChild(optFilter);

        const optA = document.createElement("option");
        optA.value = String(idx);
        optA.textContent = label;
        slotASelect.appendChild(optA);

        const optB = document.createElement("option");
        optB.value = String(idx);
        optB.textContent = label;
        slotBSelect.appendChild(optB);
      });

      // Default slot mapping: first two projects
      slotASelect.value = "0";
      if (projectsData.length > 1) {
        slotBSelect.value = "1";
      } else {
        slotBSelect.value = "0";
      }

      renderProjects();
    }

    function renderProjects() {
      const idxA = parseInt(slotASelect.value || "0", 10);
      const idxB = parseInt(slotBSelect.value || "1", 10);

      renderProjectCard(projectsSlotA, projectsData[idxA], "Slot A");
      renderProjectCard(projectsSlotB, projectsData[idxB], "Slot B");
    }

    function renderProjectCard(container, project, slotLabel) {
      if (!project) {
        container.innerHTML =
          "<div style='font-size:12px;color:var(--text-muted);'>No project selected.</div>";
        return;
      }

      const planned = toNumber(project.Planned_Progress || project.Planned_progress);
      const actual = toNumber(project.Actual_Progress);
      const risk1Level = (project.Risk1_level || "").toLowerCase();
      const risk2Level = (project.Risk2_level || "").toLowerCase();

      const riskDot1Class =
        risk1Level === "high"
          ? "high"
          : risk1Level === "medium"
          ? "medium"
          : "low";
      const riskDot2Class =
        risk2Level === "high"
          ? "high"
          : risk2Level === "medium"
          ? "medium"
          : "low";

      container.innerHTML = `
        <div class="project-header">
          <div class="project-name">${project.Project_Name || "—"}</div>
          <div class="project-stage">${project.Stage_text || ""}</div>
          <div class="project-meta">
            <span>Start: ${project.Start_Date || "—"}</span>
            <span>Duration: ${project.Planned_Duration || "—"} days</span>
            <span>Slot: ${slotLabel}</span>
          </div>
        </div>

        <div class="project-progress">
          <div class="progress-label-line">
            <span>Progress</span>
            <span>${actual || 0}% / ${planned || 0}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-actual" style="width:${Math.min(
              actual,
              100
            )}%;"></div>
            <div class="progress-bar-planned" style="width:${Math.min(
              planned,
              100
            )}%;"></div>
          </div>
        </div>

        <div class="project-risks">
          <div class="risk-pill">
            <span class="risk-dot ${riskDot1Class}"></span>
            <span>Risk 1 – ${project.Risk1_level || "N/A"}</span>
            <span class="risk-note">${
              project.Risk1_Note || "No note"
            }</span>
          </div>
          <div class="risk-pill">
            <span class="risk-dot ${riskDot2Class}"></span>
            <span>Risk 2 – ${project.Risk2_level || "N/A"}</span>
            <span class="risk-note">${
              project.Risk2_Note || "No note"
            }</span>
          </div>
        </div>
      `;
    }

    // === EVENT HANDLERS ===
    projectFilterSelect.addEventListener("change", () => {
      const value = projectFilterSelect.value;
      if (value === "first-two") {
        slotASelect.value = "0";
        if (projectsData.length > 1) {
          slotBSelect.value = "1";
        }
      } else {
        const idx = parseInt(value, 10);
        slotASelect.value = value;
        // Keep B as is unless it matches A
        if (slotBSelect.value === value && projectsData.length > 1) {
          slotBSelect.value = String((idx + 1) % projectsData.length);
        }
      }
      renderProjects();
    });

    slotASelect.addEventListener("change", renderProjects);
    slotBSelect.addEventListener("change", renderProjects);

    // === MAIN LOAD ===
    async function loadDashboard() {
      try {
        const [data1Text, projectsText] = await Promise.all([
          fetch(DATA1_CSV_URL).then((r) => r.text()),
          fetch(PROJECTS_CSV_URL).then((r) => r.text()),
        ]);

        const data1Rows = parseCsv(data1Text);
        const projectRows = parseCsv(projectsText);

        if (!data1Rows.length) throw new Error("No rows in Data1");

        // Latest month = أول صف (Google Sheets published by order)
        const latest = data1Rows[0];
        updateCashAndBudget(latest, data1Rows);
        updateCashFlowChart(data1Rows);

        projectsData = projectRows;
        buildProjectOptions();

        const now = new Date();
        lastUpdateText.textContent =
          "Last update: " +
          now.toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
      } catch (err) {
        console.error(err);
        lastUpdateText.textContent =
          "Error loading data from Google Sheets. Please check the published CSV links.";
      }
    }

    loadDashboard();
  </script>
</body>
</html>
