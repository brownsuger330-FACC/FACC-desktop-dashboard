<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FACC — First Avenue Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- Chart.js للترند -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      /* خلفية رئيسية داكنة قريبة من لون الشعار */
      --bg-main: #02151b;
      --bg-card: #022839;
      --bg-card-soft: #04323b;
      --turquoise: #00a7a5;
      --turquoise-soft: #34c7c5;
      --gold: #c5a56c;
      --text-main: #f5f7f8;
      --text-muted: #aab8bb;
      --danger: #ff5b5b;
      --warning: #ffc857;
      --success: #4cd278;
      --shadow-soft: 0 22px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 26px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #06414c, #02151b 52%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .page {
      width: 100%;
      max-width: 1440px;
      padding: 28px 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* الشعار (الختم) في الزاوية */
    .corner-logo {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(2, 21, 27, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.55);
    }

    .corner-logo img {
      width: 110%;
      height: 110%;
      object-fit: cover;
      filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.7));
    }

    /* HEADER */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 26px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e9f9ff;
    }

    .brand-subtitle {
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 14px;
      color: var(--text-muted);
    }

    .tagline {
      margin-top: 2px;
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-meta {
      text-align: right;
      font-size: 12px;
      color: var(--text-muted);
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 8px;
      font-size: 11px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 0 6px rgba(76, 210, 120, 0.25);
    }

    /* GRID LAYOUT */
    .grid {
      display: grid;
      grid-template-columns: 2fr 1.6fr;
      grid-template-rows: auto auto auto;
      gap: 18px;
    }

    .card {
      background: linear-gradient(135deg, var(--bg-card), var(--bg-card-soft));
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 20px 22px;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 15px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #eaf8ff;
    }

    .card-subtitle {
      margin-top: 4px;
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.24);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .chip-success {
      background-color: rgba(76, 210, 120, 0.16);
      border-color: rgba(76, 210, 120, 0.6);
      color: #c8ffde;
    }

    .chip-warning {
      background-color: rgba(255, 200, 87, 0.16);
      border-color: rgba(255, 200, 87, 0.7);
      color: #ffe9bd;
    }

    .chip-danger {
      background-color: rgba(255, 91, 91, 0.16);
      border-color: rgba(255, 91, 91, 0.7);
      color: #ffd2d2;
    }

    .chip-neutral {
      background-color: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .chip-dot-success {
      background: var(--success);
    }

    .chip-dot-warning {
      background: var(--warning);
    }

    .chip-dot-danger {
      background: var(--danger);
    }

    /* CASH CARD */
    .cash-main-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .cash-main-value {
      font-size: 32px;
      font-weight: 600;
    }

    .cash-main-label {
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 12px;
      color: var(--text-muted);
    }

    .cash-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    .meta-pill {
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.32);
      font-size: 11px;
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }

    .meta-label {
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 11px;
    }

    .meta-value {
      font-size: 11px;
      font-weight: 500;
    }

    /* BUDGET CARD */
    .budget-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .budget-item {
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.24);
    }

    .budget-label {
      font-family: "Cairo", system-ui, -apple-system;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .budget-value {
      font-size: 15px;
      font-weight: 500;
      color: #ffffff;
    }

    .budget-helper {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      font-family: "Cairo", system-ui, -apple-system;
    }

    /* SPENDING CAP */
    .cap-main-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .cap-amount {
      font-size: 24px;
      font-weight: 600;
    }

    .cap-caption {
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    .cap-rule {
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
      margin-top: 6px;
    }

    .progress-rail {
      margin-top: 6px;
      width: 100%;
      height: 8px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.4);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--turquoise-soft), var(--gold));
      width: 0;
      transition: width var(--transition-fast);
    }

    .progress-marker {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 14px;
      background: rgba(255, 255, 255, 0.5);
    }

    .label-row-between {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    /* CASH FLOW CHART */
    .chart-wrapper {
      margin-top: 4px;
    }

    #cashChart {
      width: 100%;
      max-height: 230px;
    }

    .chart-footnote {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    /* PROJECTS */
    .projects-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 280px;
      overflow: hidden;
    }

    .project-card {
      background: rgba(0, 0, 0, 0.26);
      border-radius: 18px;
      padding: 10px 12px 12px;
      display: grid;
      grid-template-columns: 1.5fr 1.6fr 0.9fr;
      gap: 12px;
      align-items: center;
    }

    .project-title {
      font-size: 14px;
      font-weight: 500;
    }

    .project-stage {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    .project-dates {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    .project-progress-label {
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
      margin-bottom: 4px;
    }

    .project-progress-bar {
      height: 7px;
      border-radius: var(--radius-pill);
      background: rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: relative;
    }

    .project-progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--turquoise-soft), #7cf5ff);
      width: 0;
      transition: width var(--transition-fast);
    }

    .project-progress-marker {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 13px;
      background: rgba(255, 255, 255, 0.6);
    }

    .project-progress-text {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "Cairo", system-ui, -apple-system;
    }

    .project-risks {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      font-family: "Cairo", system-ui, -apple-system;
    }

    .risk-pill {
      padding: 5px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.32);
    }

    .risk-level-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .risk-high {
      color: #ffd2d2;
      border-color: rgba(255, 91, 91, 0.6);
      background: rgba(255, 91, 91, 0.14);
    }

    .risk-medium {
      color: #ffe9bd;
      border-color: rgba(255, 200, 87, 0.7);
      background: rgba(255, 200, 87, 0.14);
    }

    .risk-low {
      color: #d0ffe7;
      border-color: rgba(76, 210, 120, 0.7);
      background: rgba(76, 210, 120, 0.14);
    }

    .risk-label {
      font-weight: 600;
      font-size: 11px;
    }

    .risk-note {
      margin-top: 2px;
      color: var(--text-muted);
    }

    /* CEO CONTROL */
    .admin-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 2fr);
      gap: 14px;
      margin-top: 10px;
      font-family: "Cairo", system-ui, -apple-system;
    }

    .admin-note {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .admin-note-strong {
      color: #ffe9bd;
    }

    .admin-badges {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
    }

    .admin-table {
      max-height: 180px;
      overflow-y: auto;
      font-size: 11px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      text-align: left;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(2, 40, 57, 0.96);
      font-weight: 500;
    }

    .admin-input {
      width: 60px;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
      font-size: 11px;
      text-align: center;
    }

    .admin-btn {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .admin-btn:hover {
      border-color: rgba(255, 255, 255, 0.32);
    }

    .footer-version {
      text-align: right;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: -8px;
      font-family: "Cairo", system-ui, -apple-system;
    }

    /* RESPONSIVE (عرض أصغر من 1100) */
    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .project-card {
        grid-template-columns: 1.2fr 1.4fr;
        grid-template-rows: auto auto;
      }

      .project-risks {
        grid-column: 1 / -1;
        flex-direction: row;
        flex-wrap: wrap;
      }

      .admin-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <!-- HEADER -->
    <header class="header">
      <div class="brand-block">
        <div class="corner-logo">
          <!-- تأكد أن اسم الملف مطابق في المستودع -->
          <img src="seal.png" alt="FACC Seal" />
        </div>
        <div class="brand-text">
          <div class="brand-title">FACC — COMMAND CENTER</div>
          <div class="brand-subtitle">
            الجادة الأولى للاستثمار | First Avenue for Investment
          </div>
          <div class="tagline">
            لوحة قيادة تنفيذية للسيولة، الميزانية، والمشاريع عالية الأولوية.
          </div>
        </div>
      </div>

      <div class="header-meta">
        <div class="live-badge">
          <span class="live-dot"></span>
          <span>LIVE SNAPSHOT</span>
          <span style="opacity: 0.7">Data1 &amp; Projects (Google Sheets)</span>
        </div>
        <div id="last-update-label">Last update: —</div>
      </div>
    </header>

    <!-- GRID -->
    <section class="grid">
      <!-- CASH OVERVIEW -->
      <section class="card" id="cash-card">
        <div class="card-header">
          <div>
            <div class="card-title">CASH BALANCE</div>
            <div class="card-subtitle">
              Bank balance after latest payments · السيولة النقدية المتاحة بعد
              آخر المدفوعات
            </div>
          </div>
          <div id="cash-status-chip" class="chip chip-neutral">
            <span class="chip-dot chip-dot-success"></span>
            <span>STATUS</span>
          </div>
        </div>

        <div class="cash-main-row">
          <div id="cash-balance" class="cash-main-value">— SAR</div>
          <div class="cash-main-label">
            Cash is higher than short-term obligations (30-day) and pending
            payments.
          </div>
        </div>

        <div class="cash-meta-row">
          <div class="meta-pill">
            <span class="meta-label">Obligations 30D:</span>
            <span id="cash-obligations" class="meta-value">— SAR</span>
          </div>
          <div class="meta-pill">
            <span class="meta-label">Pending payments:</span>
            <span id="cash-pending" class="meta-value">— SAR</span>
          </div>
        </div>
      </section>

      <!-- BUDGET CONTROL -->
      <section class="card" id="budget-card">
        <div class="card-header">
          <div>
            <div class="card-title">BUDGET CONTROL 2026</div>
            <div class="card-subtitle">
              Approved operating &amp; projects budget · ميزانية ٢٠٢٦ المعتمدة
            </div>
          </div>
          <div id="budget-status-chip" class="chip chip-neutral">
            <span class="chip-dot chip-dot-success"></span>
            <span>ON TRACK</span>
          </div>
        </div>

        <div class="budget-grid">
          <div class="budget-item">
            <div class="budget-label">Approved budget</div>
            <div id="budget-total" class="budget-value">— SAR</div>
          </div>
          <div class="budget-item">
            <div class="budget-label">Actual spend (YTD)</div>
            <div id="budget-actual" class="budget-value">— SAR</div>
          </div>
          <div class="budget-item">
            <div class="budget-label">Budget remaining</div>
            <div id="budget-remaining" class="budget-value">— SAR</div>
          </div>
          <div class="budget-item">
            <div class="budget-label">Variance vs approved</div>
            <div id="budget-variance" class="budget-value">—</div>
          </div>
        </div>

        <div class="budget-helper" id="budget-helper-text">
          Budget position will update automatically as Data1 sheet is updated.
        </div>
      </section>

      <!-- MONTHLY CAP -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">MONTHLY SPENDING CAP</div>
            <div class="card-subtitle">
              Safe envelope rule based on remaining budget · سقف الصرف الشهري
            </div>
          </div>
          <div class="chip chip-success">
            <span class="chip-dot chip-dot-success"></span>
            <span>AUTO RULE</span>
          </div>
        </div>

        <div class="cap-main-row">
          <div>
            <div id="cap-amount" class="cap-amount">— SAR</div>
            <div class="cap-caption">
              Safe monthly envelope (max 200,000 SAR · ‎٢٥٪ من الميزانية
              المتبقية بحد أعلى ٢٠٠ ألف)
            </div>
          </div>
        </div>

        <div class="progress-rail">
          <div id="cap-fill" class="progress-fill"></div>
          <div id="cap-marker" class="progress-marker"></div>
        </div>
        <div class="label-row-between">
          <span>0</span>
          <span>Rule target</span>
          <span>200K</span>
        </div>

        <div id="cap-rule-text" class="cap-rule">
          Rule: 25% of remaining budget / months left (capped at 200K).
        </div>
      </section>

      <!-- CONTROL STATUS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">CONTROL STATUS</div>
            <div class="card-subtitle">
              30-day liquidity view · تغطية الالتزامات خلال ٣٠ يوم
            </div>
          </div>
          <div id="control-status-chip" class="chip chip-neutral">
            <span class="chip-dot chip-dot-success"></span>
            <span>STATUS</span>
          </div>
        </div>

        <div class="cap-caption" id="control-status-text">
          —
        </div>
      </section>

      <!-- CASH FLOW CHART -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div>
            <div class="card-title">CASH FLOW PROJECTION — NEXT 6 MONTHS</div>
            <div class="card-subtitle">
              Based on Income_Forecast &amp; Expense_Forecast · توقع السيولة
              للأشهر الستة القادمة
            </div>
          </div>
        </div>

        <div class="chart-wrapper">
          <canvas id="cashChart"></canvas>
        </div>
        <div id="chart-footnote" class="chart-footnote">
          Values above each point show projected closing cash for the month.
        </div>
      </section>

      <!-- PROJECTS SNAPSHOT -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div>
            <div class="card-title">PROJECTS SNAPSHOT</div>
            <div class="card-subtitle">
              Top priority projects pulled from "Projects" sheet · ملخص مشاريع
              الجادة الرئيسية
            </div>
          </div>
          <div class="chip chip-neutral">
            <span class="chip-dot chip-dot-success"></span>
            <span>LIVE FROM SHEET</span>
          </div>
        </div>

        <div id="projects-list" class="projects-list">
          <!-- يتم ملؤه من الجافاسكربت -->
        </div>
      </section>

      <!-- CEO CONTROL (ADMIN) -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div>
            <div class="card-title">CEO CONTROLS (ADMIN)</div>
            <div class="card-subtitle">
              Desktop only · إعدادات محلية للتحكم في عرض المشاريع
            </div>
          </div>
          <div class="chip chip-warning">
            <span class="chip-dot chip-dot-warning"></span>
            <span>LOCAL ONLY</span>
          </div>
        </div>

        <div class="admin-layout">
          <div>
            <div class="admin-note">
              هذه المنطقة مخصصة للرئيس التنفيذي لتعديل **عرض** المشاريع بسرعة
              (Stage, Progress, Risks) على هذا الجهاز فقط. التعديلات يتم حفظها
              في <span class="admin-note-strong">localStorage</span> ولا يتم
              إرسالها إلى Google Sheets تلقائياً.
              <br /><br />
              عندما ترغب في اعتماد الأرقام نهائياً، قم بفتح شيت
              <span class="admin-note-strong">Projects</span> وتحديث القيم
              يدوياً هناك ثم سيتم جلبها تلقائياً في كل من نسخة الديسكتوب ونسخة
              الجوال.
            </div>
            <div class="admin-badges">
              <span class="chip chip-neutral" style="font-size: 10px">
                • مشروع بدون Override = الأرقام من الشيت مباشرة
              </span>
              <span class="chip chip-neutral" style="font-size: 10px">
                • مشروع مع Override = الأرقام من Admin + محفوظة على هذا
                اللابتوب فقط
              </span>
            </div>
            <button
              class="admin-btn"
              type="button"
              onclick="window.open('https://docs.google.com/spreadsheets/d/14Z3TPLYq5ufs2lTX_qkeDsV2inZeFwfMwwG9NMQQwHc/edit', '_blank')"
            >
              Open Google Sheet (Projects) · فتح شيت المشاريع
            </button>
          </div>

          <div class="admin-table">
            <table>
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Stage</th>
                  <th>Actual %</th>
                  <th>Planned %</th>
                  <th>Risk1</th>
                  <th>Risk2</th>
                </tr>
              </thead>
              <tbody id="admin-project-rows">
                <!-- يُملأ من الجافاسكربت -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="footer-version">
          FACC — First Avenue Command Center · Desktop View · v1.0
        </div>
      </section>
    </section>
  </main>

  <script>
    // ----------- الإعدادات (روابط الـCSV من Google Sheets) -----------
    const DATA1_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=0&single=true&output=csv";

    const PROJECTS_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=146585938&single=true&output=csv";

    const LOCAL_OVERRIDE_KEY = "FACC_PROJECT_OVERRIDES_V1";

    // ----------- أدوات مساعدة -----------
    function parseNumber(value) {
      if (!value) return 0;
      const clean = String(value).replace(/,/g, "").trim();
      const n = Number(clean);
      return isNaN(n) ? 0 : n;
    }

    function formatSAR(num) {
      return (
        num.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }) + " SAR"
      );
    }

    function classifyStatus(value, thresholds) {
      if (value >= thresholds.good) return "good";
      if (value >= thresholds.warning) return "warning";
      return "danger";
    }

    function applyChip(chipEl, label, status) {
      chipEl.className = "chip";
      chipEl.classList.add(
        status === "good"
          ? "chip-success"
          : status === "warning"
          ? "chip-warning"
          : "chip-danger"
      );
      const dotClass =
        status === "good"
          ? "chip-dot-success"
          : status === "warning"
          ? "chip-dot-warning"
          : "chip-dot-danger";
      chipEl.innerHTML = `
        <span class="chip-dot ${dotClass}"></span>
        <span>${label}</span>
      `;
    }

    function loadOverrides() {
      try {
        const raw = localStorage.getItem(LOCAL_OVERRIDE_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveOverrides(overrides) {
      try {
        localStorage.setItem(LOCAL_OVERRIDE_KEY, JSON.stringify(overrides));
      } catch {
        // ignore
      }
    }

    // ----------- قراءة CSV بسيطة -----------
    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(",").map((h) => h.trim());
      const rows = lines.slice(1).map((line) => {
        const cells = line.split(",").map((c) => c.trim());
        const obj = {};
        headers.forEach((h, idx) => {
          obj[h] = cells[idx] ?? "";
        });
        return obj;
      });
      return { headers, rows };
    }

    // ----------- بناء الداشبورد -----------
    let cashChart;

    async function buildDashboard() {
      const [data1, projectsData] = await Promise.all([
        fetchCSV(DATA1_URL),
        fetchCSV(PROJECTS_URL),
      ]);

      const now = new Date();
      const lastUpdateLabel = document.getElementById("last-update-label");
      lastUpdateLabel.textContent =
        "Last update: " +
        now.toLocaleString("en-GB", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

      // ---- DATA1: نفترض 12 شهر + صف snapshot الحالي في أول صف بعد الهيدر ----
      const months = data1.rows.map((r) => r.Month || r.month || "");
      const cashBalances = data1.rows.map((r) =>
        parseNumber(r.Cash_Balance || r.cash_balance)
      );
      const pendingPayments = data1.rows.map((r) =>
        parseNumber(r.Pending_Payments || r.pending_payments)
      );
      const obligations30D = data1.rows.map((r) =>
        parseNumber(r.Obligation_30D || r.obligation_30d)
      );
      const budgetTotalRaw = parseNumber(
        data1.rows[0].Budget_Total || data1.rows[0].budget_total
      );
      const incomeForecast = data1.rows.map((r) =>
        parseNumber(r.Income_Forcast || r.Income_Forecast || r.income_forecast)
      );
      const expenseForecast = data1.rows.map((r) =>
        parseNumber(
          r.Expense_Forcast || r.Expense_Forecast || r.expense_forecast
        )
      );
      const actualExpense = data1.rows.map((r) =>
        parseNumber(r.Actual_Expense || r.actual_expense)
      );

      // snapshot نأخذ أول صف كالحالي (DEC-25) حسب الشيت الحالي
      const snapshotIndex = 0;

      const cashBalance = cashBalances[snapshotIndex] || 0;
      const pending = pendingPayments[snapshotIndex] || 0;
      const obligations = obligations30D[snapshotIndex] || 0;

      // --- CASH CARD ---
      document.getElementById("cash-balance").textContent =
        formatSAR(cashBalance);
      document.getElementById("cash-obligations").textContent =
        formatSAR(obligations);
      document.getElementById("cash-pending").textContent =
        formatSAR(pending);

      // --- BUDGET NUMBERS ---
      const budgetTotal = budgetTotalRaw;
      const actualYTD = actualExpense.reduce((sum, v) => sum + v, 0);
      const remaining = Math.max(budgetTotal - actualYTD, 0);
      const variance = remaining; // نفس المتبقي (موجب = أقل من الميزانية)

      document.getElementById("budget-total").textContent =
        formatSAR(budgetTotal);
      document.getElementById("budget-actual").textContent =
        formatSAR(actualYTD);
      document.getElementById("budget-remaining").textContent =
        formatSAR(remaining);
      document.getElementById("budget-variance").textContent =
        formatSAR(variance);

      const budgetStatus =
        actualYTD <= budgetTotal * 0.6
          ? "good"
          : actualYTD <= budgetTotal * 0.85
          ? "warning"
          : "danger";

      const budgetChip = document.getElementById("budget-status-chip");
      applyChip(
        budgetChip,
        budgetStatus === "good"
          ? "UNDER CONTROL"
          : budgetStatus === "warning"
          ? "TIGHT RANGE"
          : "OVER BUDGET",
        budgetStatus
      );

      const budgetHelper = document.getElementById("budget-helper-text");
      if (budgetStatus === "good") {
        budgetHelper.textContent =
          "Actual spend is comfortably within the approved budget range.";
      } else if (budgetStatus === "warning") {
        budgetHelper.textContent =
          "Spending is approaching the upper comfort band. Monitor new commitments.";
      } else {
        budgetHelper.textContent =
          "Spending is above the safe band vs approved budget. Review commitments.";
      }

      // --- MONTHLY CAP RULE ---
      const totalMonths = months.length || 12;
      const monthsWithActual = actualExpense.filter((v) => v > 0).length;
      const monthsLeft = Math.max(totalMonths - monthsWithActual, 1);
      const ruleCap = (remaining * 0.25) / monthsLeft;
      const maxCap = 200000;
      const capPerMonth = Math.min(ruleCap, maxCap);

      document.getElementById("cap-amount").textContent =
        formatSAR(capPerMonth);
      document.getElementById(
        "cap-rule-text"
      ).textContent = `Rule: (25% of remaining budget ÷ months left = ${formatSAR(
        ruleCap
      )}) · Capped at 200,000 SAR.`;

      const capFill = document.getElementById("cap-fill");
      const capMarker = document.getElementById("cap-marker");
      const capPercent = Math.min(capPerMonth / maxCap, 1);
      capFill.style.width = `${capPercent * 100}%`;
      capMarker.style.left = `${capPercent * 100}%`;

      // --- CONTROL STATUS ---
      const cashStatusScore = cashBalance - (obligations + pending + capPerMonth);
      const controlStatus = classifyStatus(cashStatusScore, {
        good: 0,
        warning: -maxCap * 0.25,
      });
      const controlChip = document.getElementById("control-status-chip");
      applyChip(
        controlChip,
        controlStatus === "good"
          ? "UNDER CONTROL"
          : controlStatus === "warning"
          ? "TIGHT"
          : "CRITICAL",
        controlStatus
      );

      const controlText = document.getElementById("control-status-text");
      if (controlStatus === "good") {
        controlText.textContent =
          "Cash comfortably covers 30-day obligations, pending payments, and the safe monthly envelope.";
      } else if (controlStatus === "warning") {
        controlText.textContent =
          "Coverage of 30-day obligations and pending payments is tight once the monthly envelope is considered.";
      } else {
        controlText.textContent =
          "Cash is below the comfortable zone vs obligations, pending payments, and monthly envelope. Consider deferring non-essential spending.";
      }

      // --- CASH STATUS CHIP (فقط إشارة مباشرة من نسبة الرصيد للالتزامات) ---
      const coverageRatio =
        obligations + pending > 0
          ? cashBalance / (obligations + pending)
          : 999;

      const cashStatus = classifyStatus(coverageRatio, {
        good: 2,
        warning: 1.2,
      });

      const cashChip = document.getElementById("cash-status-chip");
      applyChip(
        cashChip,
        cashStatus === "good"
          ? "COMFORTABLE"
          : cashStatus === "warning"
          ? "TIGHT"
          : "WEAK",
        cashStatus
      );

      // --- CASH FLOW PROJECTION (6 أشهر) ---
      const projectionCount = Math.min(6, months.length);
      const projMonths = months.slice(0, projectionCount);
      const projIncome = incomeForecast.slice(0, projectionCount);
      const projExpense = expenseForecast.slice(0, projectionCount);

      let runningCash = cashBalance;
      const closingCash = projMonths.map((_, i) => {
        runningCash += projIncome[i] - projExpense[i];
        return runningCash;
      });

      const ctx = document.getElementById("cashChart").getContext("2d");
      if (cashChart) cashChart.destroy();
      cashChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: projMonths,
          datasets: [
            {
              label: "Projected closing cash",
              data: closingCash,
              borderColor: "#34c7c5",
              backgroundColor: "rgba(52,199,197,0.12)",
              borderWidth: 2,
              tension: 0.32,
              pointRadius: 4,
              pointHoverRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => formatSAR(ctx.parsed.y),
              },
            },
            datalabels: false,
          },
          scales: {
            x: {
              ticks: {
                color: "#9fbac0",
                font: { size: 11 },
              },
              grid: { display: false },
            },
            y: {
              ticks: {
                color: "#4f676d",
                font: { size: 10 },
                callback: (value) =>
                  value >= 1000000
                    ? value / 1000000 + "M"
                    : value / 1000 + "K",
              },
              grid: {
                color: "rgba(255,255,255,0.05)",
              },
            },
          },
          elements: {
            point: {
              borderColor: "#02151b",
            },
          },
        },
      });

      // إظهار المبالغ فوق كل نقطة (نستخدم DOM بسيطاً فوق الكانفس)
      const chartFootnote = document.getElementById("chart-footnote");
      chartFootnote.textContent =
        "Projected closing cash per month (values shown in SAR above each point in tooltip).";

      // --- PROJECTS SNAPSHOT + ADMIN ---
      const overrides = loadOverrides();
      const projects = projectsData.rows
        .filter((r) => (r.Project_Name || r.Project_ID || "").trim() !== "")
        .map((r, index) => {
          const base = {
            id: (r.Project_ID || String(index + 1)).trim(),
            name: (r.Project_Name || "").trim(),
            stage: (r.Stage_text || r.Stage_Text || "").trim(),
            startDate: (r.Start_Date || "").trim(),
            plannedDuration: parseNumber(r.Planned_Duration),
            actualProgress: parseNumber(r.Actual_Progress),
            plannedProgress: parseNumber(r.Planned_Progress),
            risk1Level: (r.Risk1_level || r.Risk1_Level || "").trim(),
            risk1Note: (r.Risk1_Note || "").trim(),
            risk2Level: (r.Risk2_level || r.Risk2_Level || "").trim(),
            risk2Note: (r.Risk2_Note || "").trim(),
          };
          const key = base.id;
          if (overrides[key]) {
            return { ...base, ...overrides[key] };
          }
          return base;
        });

      const projectsList = document.getElementById("projects-list");
      projectsList.innerHTML = "";
      projects.forEach((p) => {
        const actualPct = p.actualProgress || 0;
        const plannedPct = p.plannedProgress || 0;
        const riskClass = (level) => {
          const l = (level || "").toLowerCase();
          if (l.startsWith("high")) return "risk-high";
          if (l.startsWith("medium")) return "risk-medium";
          if (l.startsWith("low")) return "risk-low";
          return "risk-medium";
        };

        const projectEl = document.createElement("div");
        projectEl.className = "project-card";
        projectEl.innerHTML = `
          <div>
            <div class="project-title">${p.name || "Unnamed project"}</div>
            <div class="project-stage">${p.stage || "— Stage not set"}</div>
            <div class="project-dates">
              Start: ${p.startDate || "—"} · Duration: ${
          p.plannedDuration || 0
        } days
            </div>
          </div>

          <div>
            <div class="project-progress-label">Progress · نسبة إنجاز المشروع</div>
            <div class="project-progress-bar">
              <div class="project-progress-fill" style="width: ${Math.min(
                actualPct,
                100
              )}%"></div>
              <div class="project-progress-marker" style="left: ${Math.min(
                plannedPct,
                100
              )}%"></div>
            </div>
            <div class="project-progress-text">
              Actual: ${actualPct}% · Planned: ${plannedPct}%
            </div>
          </div>

          <div class="project-risks">
            <div class="risk-pill ${riskClass(p.risk1Level)}">
              <span class="risk-level-dot"></span>
              <span class="risk-label">Risk 1: ${p.risk1Level || "N/A"}</span>
            </div>
            ${
              p.risk1Note
                ? `<div class="risk-note">${p.risk1Note}</div>`
                : ""
            }
            <div class="risk-pill ${riskClass(p.risk2Level)}">
              <span class="risk-level-dot"></span>
              <span class="risk-label">Risk 2: ${p.risk2Level || "N/A"}</span>
            </div>
            ${
              p.risk2Note
                ? `<div class="risk-note">${p.risk2Note}</div>`
                : ""
            }
          </div>
        `;
        projectsList.appendChild(projectEl);
      });

      // --- ADMIN TABLE (CEO CONTROL) ---
      const adminBody = document.getElementById("admin-project-rows");
      adminBody.innerHTML = "";
      projects.forEach((p) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.name || "Project " + p.id}</td>
          <td>${p.stage || "—"}</td>
          <td>
            <input class="admin-input" type="number" min="0" max="100" value="${
              p.actualProgress || ""
            }" data-id="${p.id}" data-field="actualProgress" />
          </td>
          <td>
            <input class="admin-input" type="number" min="0" max="100" value="${
              p.plannedProgress || ""
            }" data-id="${p.id}" data-field="plannedProgress" />
          </td>
          <td>
            <input class="admin-input" type="text" value="${
              p.risk1Level || ""
            }" data-id="${p.id}" data-field="risk1Level" />
          </td>
          <td>
            <input class="admin-input" type="text" value="${
              p.risk2Level || ""
            }" data-id="${p.id}" data-field="risk2Level" />
          </td>
        `;
        adminBody.appendChild(row);
      });

      adminBody.addEventListener("change", (e) => {
        const input = e.target;
        if (!input.classList.contains("admin-input")) return;
        const id = input.getAttribute("data-id");
        const field = input.getAttribute("data-field");
        const value = input.value;

        const currentOverrides = loadOverrides();
        const projectOverride = currentOverrides[id] || {};
        if (field === "actualProgress" || field === "plannedProgress") {
          projectOverride[field] = parseNumber(value);
        } else {
          projectOverride[field] = value;
        }
        currentOverrides[id] = projectOverride;
        saveOverrides(currentOverrides);
        // إعادة البناء لتحديث بطاقات المشاريع
        buildDashboard().catch(console.error);
      }, { once: false });
    }

    buildDashboard().catch((err) => {
      console.error("Error building dashboard", err);
      const label = document.getElementById("last-update-label");
      label.textContent = "Error loading data from Google Sheets.";
    });
  </script>
</body>
</html>
