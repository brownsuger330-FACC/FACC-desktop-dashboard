<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FACC — First Avenue Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Font (يمكن تغييرها لاحقاً لو أحببت) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* ========== ألوان وهوية FACC ========== */
    :root {
      --bg-dark: #022839;
      --bg-dark-soft: #04323b;
      --bg-card-soft: #06414c;
      --turquoise-soft: #0a7a85;
      --turquoise-soft-alt: #34c7c5;
      --gold: #c5a56c;
      --text-main: #f5f7f8;
      --text-muted: #aab3b8;
      --danger: #ff5b5b;
      --warning: #ffc857;
      --success: #3cd278;
      --shadow-soft: 0 22px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 28px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #06414c, #02151b 52%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .page {
      width: 100%;
      max-width: 1440px;
      padding: 28px 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 22px;
      position: relative;
    }

    /* ختم الزاوية */
    .corner-seal {
      position: fixed;
      left: 24px;
      bottom: 24px;
      width: 64px;
      height: 64px;
      opacity: 0.9;
      z-index: 9999;
      filter: drop-shadow(0 0 12px rgba(0, 0, 0, 0.5));
    }

    /* ========== الهيدر ========== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.12em;
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--turquoise-soft-alt);
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin-top: 2px;
    }

    .brand-ar {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.42);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2ee18a;
      box-shadow: 0 0 10px rgba(46, 225, 138, 0.7);
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .last-update {
      font-size: 11px;
      color: var(--text-muted);
    }

    .view-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(255, 255, 255, 0.4);
    }

    /* ========== تخطيط البودي ========== */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 20px;
      align-items: flex-start;
    }

    .card {
      background: linear-gradient(135deg, rgba(4, 50, 59, 0.98), #031b26);
      border-radius: var(--radius-lg);
      padding: 18px 20px 20px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: rgba(0, 0, 0, 0.4);
    }

    .chip.good {
      color: #0fdf9f;
      background: rgba(15, 223, 159, 0.1);
    }

    .chip.warn {
      color: var(--warning);
      background: rgba(255, 200, 87, 0.12);
    }

    .chip.bad {
      color: var(--danger);
      background: rgba(255, 91, 91, 0.12);
    }

    .chip.neutral {
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.04);
    }

    /* ========== كروت الكاش والميزانية ========== */
    .cash-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.05fr);
      gap: 18px;
      margin-top: 6px;
    }

    .cash-main-value {
      font-size: 28px;
      font-weight: 600;
    }

    .currency {
      font-size: 13px;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .metric-row strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .metric-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot-pill {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--turquoise-soft-alt);
    }

    .small-caption {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== كارت الميزانية ========== */
    .budget-main {
      font-size: 20px;
      font-weight: 600;
    }

    .budget-meta {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-badge {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 11px;
    }

    .variance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 12px;
    }

    .variance-value {
      font-weight: 500;
    }

    .variance-positive {
      color: var(--success);
    }

    .variance-negative {
      color: var(--danger);
    }

    /* ========== شارت التدفقات لستة أشهر ========== */
    .chart-wrapper {
      margin-top: 14px;
      padding: 10px 12px 6px;
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top left, #053341, #02151f);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .chart-legend {
      display: flex;
      gap: 10px;
      font-size: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--turquoise-soft-alt);
    }

    .legend-dot.net {
      background: var(--gold);
    }

    .chart-svg {
      width: 100%;
      height: 150px;
    }

    /* ========== كارت المشاريع ========== */
    .projects-card {
      margin-top: 10px;
    }

    .projects-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .smart-filter {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .smart-filter select {
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: var(--radius-pill);
      padding: 3px 10px;
      color: var(--text-main);
      font-size: 11px;
      outline: none;
      cursor: pointer;
    }

    .project-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .project-card {
      background: linear-gradient(135deg, #031b26, #052c35);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      position: relative;
      overflow: hidden;
    }

    .project-slot-label {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      opacity: 0.9;
    }

    .project-name {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .project-stage {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .project-dates {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .project-progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 11px;
    }

    .progress-bar {
      position: relative;
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      overflow: hidden;
      margin: 0 8px;
    }

    .progress-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--turquoise-soft-alt), #53ffb2);
      border-radius: inherit;
      transition: width var(--transition-fast);
    }

    .project-risk-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
    }

    .risk-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.4);
      white-space: nowrap;
    }

    .risk-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--danger);
    }

    .risk-medium .risk-dot {
      background: var(--warning);
    }

    .risk-low .risk-dot {
      background: var(--success);
    }

    .risk-text {
      color: var(--text-muted);
      font-size: 10px;
      margin-top: 4px;
    }

    /* ========== كارت كنترول المدير التنفيذي ========== */
    .admin-card {
      margin-top: 10px;
      padding-top: 14px;
      border-top: 1px dashed rgba(255, 255, 255, 0.16);
      font-size: 11px;
      color: var(--text-muted);
    }

    .admin-grid {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 8px;
      align-items: flex-start;
    }

    .admin-selects {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .admin-selects label {
      font-size: 11px;
    }

    .admin-selects select {
      background: rgba(0, 0, 0, 0.4);
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      color: var(--text-main);
      font-size: 11px;
      outline: none;
      min-width: 120px;
      cursor: pointer;
    }

    .admin-note {
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 360px;
    }

    .badge-desktop-only {
      align-self: flex-start;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
    }

    /* ========== النصوص الجانبية الرأسية ========== */
    .vertical-tag {
      position: fixed;
      right: 18px;
      top: 50%;
      transform: translateY(-50%) rotate(90deg);
      transform-origin: center;
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.32);
      pointer-events: none;
    }

    .vertical-version {
      position: fixed;
      left: 18px;
      top: 50%;
      transform: translateY(-50%) rotate(-90deg);
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.28);
      pointer-events: none;
    }

    /* ========== ريسبونسف بسيط للشاشات الأصغر ========== */
    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .vertical-tag,
      .vertical-version {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- ختم الجادة في الزاوية -->
  <img src="seal.png" alt="FACC Seal" class="corner-seal" />

  <div class="page">
    <!-- الهيدر -->
    <header class="header">
      <div class="brand">
        <div>
          <div class="brand-title">FACC — COMMAND CENTER</div>
          <div class="brand-subtitle">FIRST AVENUE FOR INVESTMENT</div>
          <div class="brand-ar">الجادة الأولى للإستثمار | لوحة القيادة التنفيذية للرئيس التنفيذي</div>
        </div>
      </div>

      <div class="header-meta">
        <div class="status-pill">
          <span class="status-dot"></span>
          LIVE SNAPSHOT
        </div>
        <div class="last-update" id="last-update"></div>
        <div class="view-tag">INTERNAL CEO VIEW — DESKTOP</div>
      </div>
    </header>

    <!-- جسم الصفحة -->
    <main class="layout">
      <!-- العمود الأيسر: الكاش + الميزانية + الشارت -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">CASH OVERVIEW</div>
            <div class="card-subtitle">Bank balance after latest payments</div>
          </div>
          <span class="chip good" id="cash-status-chip">COMFORTABLE</span>
        </div>

        <div class="cash-grid">
          <!-- كارت الكاش -->
          <div>
            <div class="cash-main-value">
              <span id="cash-balance">0</span>
              <span class="currency">SAR</span>
            </div>

            <div class="metric-row">
              <div class="metric-label">
                <span class="dot-pill"></span>
                Pending payments
              </div>
              <strong id="pending-payments">0 SAR</strong>
            </div>

            <div class="metric-row">
              <div class="metric-label">
                <span class="dot-pill"></span>
                30-day obligations
              </div>
              <strong id="obligation-30d">0 SAR</strong>
            </div>

            <p class="small-caption">
              Cash position versus short-term obligations (after pending payments and 30-day commitments).
            </p>
          </div>

          <!-- كارت الميزانية -->
          <div>
            <div class="card-header" style="margin-bottom: 4px;">
              <div>
                <div class="card-title">BUDGET &amp; VARIANCE</div>
                <div class="card-subtitle">Year 2026 budget vs projected spend</div>
              </div>
              <span class="chip neutral" id="budget-status-chip">ON TRACK</span>
            </div>

            <div class="budget-main">
              <span id="budget-total">0</span>
              <span class="currency">SAR</span>
            </div>

            <div class="budget-meta">
              <div>
                <div style="font-size: 11px; color: var(--text-muted);">Projected spend (net)</div>
                <div style="font-weight: 500;" id="projected-spend">0 SAR</div>
              </div>
              <div>
                <div style="font-size: 11px; color: var(--text-muted);">Auto monthly cap</div>
                <div style="font-weight: 500;" id="monthly-cap">0 SAR</div>
              </div>
            </div>

            <div class="variance-row">
              <div class="pill-badge">
                Variance vs budget:
                <span id="variance-pct">(0%)</span>
              </div>
              <div class="variance-value" id="variance-amount">0 SAR</div>
            </div>

            <p class="small-caption">
              Budget is read from <strong>Data1</strong> (Budget_Total for 2026). Variance uses actual + forecasted expenses.
            </p>
          </div>
        </div>

        <!-- شارت التدفقات لستة أشهر -->
        <div class="chart-wrapper">
          <div class="chart-header">
            <span>Cash flow projection — next 6 months</span>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-dot"></span> Net cash
              </div>
            </div>
          </div>
          <svg class="chart-svg" viewBox="0 0 100 50" preserveAspectRatio="none" id="cash-chart"></svg>
          <div class="small-caption">
            Based on Income_Forcast − Expense_Forcast from <strong>Data1</strong>, starting from net cash after 30-day obligations.
          </div>
        </div>
      </section>

      <!-- العمود الأيمن: المشاريع + كنترول المدير -->
      <section class="card projects-card">
        <div class="card-header">
          <div>
            <div class="card-title">PROJECTS SNAPSHOT</div>
            <div class="card-subtitle">ثلاثة مشاريع كحد أقصى يتم تنفيذها في نفس الوقت</div>
          </div>
          <span class="chip neutral">LIVE FROM PROJECTS SHEET</span>
        </div>

        <div class="projects-header-line">
          <span>مشروعات الجادة | Projects radar</span>
          <div class="smart-filter">
            <span style="font-size: 11px;">Smart filter</span>
            <select id="slot-a-select"></select>
            <select id="slot-b-select"></select>
          </div>
        </div>

        <div class="project-list">
          <!-- مشروع Slot A -->
          <article class="project-card" id="project-slot-a">
            <div class="project-slot-label">SLOT A</div>
            <div class="project-name" id="projA-name">—</div>
            <div class="project-stage" id="projA-stage">—</div>
            <div class="project-dates">
              <span id="projA-dates">—</span>
              <span id="projA-duration">—</span>
            </div>

            <div class="project-progress-row">
              <span style="font-size: 11px;">Progress</span>
              <div class="progress-bar">
                <div class="progress-fill" id="projA-progress-fill" style="width:0%;"></div>
              </div>
              <span id="projA-progress-label">0% / 0%</span>
            </div>

            <div class="project-risk-row">
              <div>
                <div class="risk-badge" id="projA-risk1-badge">
                  <span class="risk-dot"></span>
                  <span id="projA-risk1-level">—</span>
                </div>
                <div class="risk-text" id="projA-risk1-note">—</div>
              </div>
              <div>
                <div class="risk-badge" id="projA-risk2-badge">
                  <span class="risk-dot"></span>
                  <span id="projA-risk2-level">—</span>
                </div>
                <div class="risk-text" id="projA-risk2-note">—</div>
              </div>
            </div>
          </article>

          <!-- مشروع Slot B -->
          <article class="project-card" id="project-slot-b">
            <div class="project-slot-label">SLOT B</div>
            <div class="project-name" id="projB-name">—</div>
            <div class="project-stage" id="projB-stage">—</div>
            <div class="project-dates">
              <span id="projB-dates">—</span>
              <span id="projB-duration">—</span>
            </div>

            <div class="project-progress-row">
              <span style="font-size: 11px;">Progress</span>
              <div class="progress-bar">
                <div class="progress-fill" id="projB-progress-fill" style="width:0%;"></div>
              </div>
              <span id="projB-progress-label">0% / 0%</span>
            </div>

            <div class="project-risk-row">
              <div>
                <div class="risk-badge" id="projB-risk1-badge">
                  <span class="risk-dot"></span>
                  <span id="projB-risk1-level">—</span>
                </div>
                <div class="risk-text" id="projB-risk1-note">—</div>
              </div>
              <div>
                <div class="risk-badge" id="projB-risk2-badge">
                  <span class="risk-dot"></span>
                  <span id="projB-risk2-level">—</span>
                </div>
                <div class="risk-text" id="projB-risk2-note">—</div>
              </div>
            </div>
          </article>
        </div>

        <!-- كنترول المدير التنفيذي -->
        <div class="admin-card">
          <div class="admin-grid">
            <div class="admin-selects">
              <span class="badge-desktop-only">CEO CONTROLS (ADMIN) — DESKTOP ONLY</span>

              <label>
                Slot A project (Project_ID):
                <select id="admin-slot-a"></select>
              </label>

              <label>
                Slot B project (Project_ID):
                <select id="admin-slot-b"></select>
              </label>
            </div>

            <p class="admin-note">
              • هذا التحكم يقوم فقط باختيار المشروع المعروض في Slot A و Slot B على شاشة الديسكتوب والجوال.<br />
              • بيانات المشروع التفصيلية (Stage, Start Date, Duration, Progress, Risks) يتم تحديثها من شيت
              <strong>Projects</strong> في Google Sheets.<br />
              • بمجرد تحديث الشيت، تقوم لوحة القيادة بقراءة البيانات الجديدة عند إعادة تحميل الصفحة، ليتم عكسها تلقائياً على
              نسخة الديسكتوب ونسخة الجوال (التي سنبنيها لاحقاً).
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- نصوص رأسية -->
    <div class="vertical-tag">
      FACC — FIRST AVENUE COMMAND CENTER | INTERNAL CEO VIEW
    </div>
    <div class="vertical-version">
      v1.0 — DESKTOP DASHBOARD
    </div>
  </div>

  <script>
    // ===== روابط CSV =====
    const DATA1_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=0&single=true&output=csv";

    const PROJECTS_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=146585938&single=true&output=csv";

    // ===== أدوات مساعدة =====
    function formatSAR(value) {
      const n = Number(value) || 0;
      return n.toLocaleString("en-US", {
        maximumFractionDigits: 2,
        minimumFractionDigits: 2,
      });
    }

    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      const headers = rows[0].split(",");
      return rows.slice(1).map((row) => {
        const cols = row.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = (cols[i] || "").trim();
        });
        return obj;
      });
    }

    function setChip(el, tone, label) {
      el.classList.remove("good", "warn", "bad", "neutral");
      el.classList.add(tone);
      el.textContent = label;
    }

    function riskClass(level) {
      const lv = (level || "").toLowerCase();
      if (lv.startsWith("high")) return "";
      if (lv.startsWith("medium")) return "risk-medium";
      if (lv.startsWith("low")) return "risk-low";
      return "";
    }

    // ===== تحميل Data1 =====
    async function loadData1() {
      const res = await fetch(DATA1_CSV_URL);
      const text = await res.text();
      const rows = parseCSV(text);

      if (!rows.length) return;

      // نفترض أن الصف الأول هو الشهر الحالي (DEC-25) كما في إعدادك
      const currentRow = rows[0];
      const yearRows = rows.slice(1); // أشهر 2026

      const cashBalance = Number(currentRow["Cash_Balance"] || 0);
      const pendingPayments = Number(currentRow["Pending_Payments"] || 0);
      const obligation30D = Number(currentRow["Obligation_30D"] || 0);

      // ميزانية السنة: أول صف يحتوي Budget_Total
      const budgetRow = rows.find(
        (r) => r["Budget_Total"] && r["Budget_Total"].trim() !== ""
      );
      const budgetTotal = budgetRow ? Number(budgetRow["Budget_Total"] || 0) : 0;

      const incomeForecastTotal = yearRows.reduce(
        (sum, r) => sum + Number(r["Income_Forcast"] || 0),
        0
      );
      const expenseForecastTotal = yearRows.reduce(
        (sum, r) => sum + Number(r["Expense_Forcast"] || 0),
        0
      );
      const actualYTD = yearRows.reduce(
        (sum, r) => sum + Number(r["Actual_Expense"] || 0),
        0
      );

      const projectedSpend = expenseForecastTotal + actualYTD;
      const variance = budgetTotal - projectedSpend;
      const variancePct = budgetTotal
        ? Math.round((variance / budgetTotal) * 100)
        : 0;
      const monthlyCap = budgetTotal / 12 || 0;

      // تحديث كروت الكاش والميزانية
      document.getElementById("cash-balance").textContent =
        formatSAR(cashBalance);
      document.getElementById(
        "pending-payments"
      ).textContent = `${formatSAR(pendingPayments)} SAR`;
      document.getElementById(
        "obligation-30d"
      ).textContent = `${formatSAR(obligation30D)} SAR`;

      document.getElementById("budget-total").textContent =
        formatSAR(budgetTotal);
      document.getElementById(
        "projected-spend"
      ).textContent = `${formatSAR(projectedSpend)} SAR`;
      document.getElementById(
        "monthly-cap"
      ).textContent = `${formatSAR(monthlyCap)} SAR`;

      const varianceAmountEl = document.getElementById("variance-amount");
      varianceAmountEl.textContent = `${formatSAR(variance)} SAR`;
      const variancePctEl = document.getElementById("variance-pct");
      variancePctEl.textContent = `(${variancePct}% ${
        variance >= 0 ? "under" : "over"
      } budget)`;

      varianceAmountEl.classList.remove(
        "variance-positive",
        "variance-negative"
      );
      if (variance >= 0) {
        varianceAmountEl.classList.add("variance-positive");
      } else {
        varianceAmountEl.classList.add("variance-negative");
      }

      // حالة الكاش
      const cashStatusChip = document.getElementById("cash-status-chip");
      const coverage = obligation30D
        ? cashBalance / obligation30D
        : cashBalance > 0
        ? 3
        : 0;

      if (coverage >= 2) {
        setChip(cashStatusChip, "good", "COMFORTABLE");
      } else if (coverage >= 1) {
        setChip(cashStatusChip, "warn", "TIGHT");
      } else {
        setChip(cashStatusChip, "bad", "CRITICAL");
      }

      // حالة الميزانية
      const budgetStatusChip = document.getElementById("budget-status-chip");
      if (variancePct >= 10) {
        setChip(budgetStatusChip, "good", "AHEAD OF BUDGET");
      } else if (variancePct >= 0) {
        setChip(budgetStatusChip, "neutral", "ON TRACK");
      } else if (variancePct <= -10) {
        setChip(budgetStatusChip, "bad", "OVER BUDGET");
      } else {
        setChip(budgetStatusChip, "warn", "TIGHT VS BUDGET");
      }

      // شارت التدفقات لـ 6 أشهر
      buildCashChart({
        rows: yearRows,
        cashBalance,
        pendingPayments,
        obligation30D,
      });
    }

    function buildCashChart({ rows, cashBalance, pendingPayments, obligation30D }) {
      const svg = document.getElementById("cash-chart");
      svg.innerHTML = "";

      const months = rows.slice(0, 6); // أول ستة أشهر من 2026
      if (!months.length) return;

      let availableStart =
        cashBalance - pendingPayments - obligation30D; // نقطة البداية
      let running = availableStart;

      const points = months.map((r) => {
        const income = Number(r["Income_Forcast"] || 0);
        const expense = Number(r["Expense_Forcast"] || 0);
        const net = income - expense;
        running += net;
        return {
          label: r["Month"] || "",
          value: running,
        };
      });

      // استخراج الحدود للرسم
      const values = [availableStart, ...points.map((p) => p.value)];
      const minVal = Math.min(...values);
      const maxVal = Math.max(...values);
      const range = maxVal - minVal || 1;

      // تحويل نقطة إلى إحداثيات SVG (0-100 في X ، 0-50 في Y)
      function toX(i) {
        const n = points.length;
        return (i / (n - 1 || 1)) * 95 + 3; // هامش بسيط
      }
      function toY(val) {
        const norm = (val - minVal) / range; // 0..1
        const y = 45 - norm * 35; // عكسي لأن SVG y للأسفل
        return y;
      }

      // خط الكاش
      let d = "";
      points.forEach((p, idx) => {
        const x = toX(idx);
        const y = toY(p.value);
        d += (idx === 0 ? "M" : "L") + x + " " + y + " ";
      });

      const path = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "path"
      );
      path.setAttribute("d", d.trim());
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "#c5a56c");
      path.setAttribute("stroke-width", "1.2");
      path.setAttribute("stroke-linejoin", "round");
      path.setAttribute("stroke-linecap", "round");
      svg.appendChild(path);

      // نقاط و قيم
      points.forEach((p, idx) => {
        const x = toX(idx);
        const y = toY(p.value);

        const circle = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle"
        );
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", "1.4");
        circle.setAttribute("fill", "#ffffff");
        svg.appendChild(circle);

        const label = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text"
        );
        label.setAttribute("x", x);
        label.setAttribute("y", 48);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("font-size", "4");
        label.setAttribute("fill", "#8ea3b0");
        const m = (p.label || "").split("-")[0]; // جزء الشهر فقط
        label.textContent = m;
        svg.appendChild(label);
      });
    }

    // ===== تحميل بيانات المشاريع =====
    let projects = [];
    let slotAId = null;
    let slotBId = null;

    async function loadProjects() {
      const res = await fetch(PROJECTS_CSV_URL);
      const text = await res.text();
      projects = parseCSV(text).filter((p) => p["Project_ID"]);

      if (!projects.length) return;

      // افتراضياً: أول مشروعين للـ Slots
      slotAId = projects[0]["Project_ID"];
      slotBId = projects[1] ? projects[1]["Project_ID"] : projects[0]["Project_ID"];

      setupProjectSelects();
      renderProjectSlots();
    }

    function setupProjectSelects() {
      const optionsHtml = projects
        .map(
          (p) =>
            `<option value="${p["Project_ID"]}">${p["Project_ID"]} — ${p["Project_Name"]}</option>`
        )
        .join("");

      const slotASelect = document.getElementById("slot-a-select");
      const slotBSelect = document.getElementById("slot-b-select");
      const adminSlotA = document.getElementById("admin-slot-a");
      const adminSlotB = document.getElementById("admin-slot-b");

      slotASelect.innerHTML = optionsHtml;
      slotBSelect.innerHTML = optionsHtml;
      adminSlotA.innerHTML = optionsHtml;
      adminSlotB.innerHTML = optionsHtml;

      slotASelect.value = slotAId;
      adminSlotA.value = slotAId;
      slotBSelect.value = slotBId;
      adminSlotB.value = slotBId;

      function updateSlotsFromAdmin() {
        slotAId = adminSlotA.value;
        slotBId = adminSlotB.value;
        slotASelect.value = slotAId;
        slotBSelect.value = slotBId;
        renderProjectSlots();
      }

      adminSlotA.addEventListener("change", updateSlotsFromAdmin);
      adminSlotB.addEventListener("change", updateSlotsFromAdmin);

      slotASelect.addEventListener("change", (e) => {
        slotAId = e.target.value;
        adminSlotA.value = slotAId;
        renderProjectSlots();
      });

      slotBSelect.addEventListener("change", (e) => {
        slotBId = e.target.value;
        adminSlotB.value = slotBId;
        renderProjectSlots();
      });
    }

    function renderProjectSlots() {
      const projA = projects.find((p) => p["Project_ID"] === slotAId) || projects[0];
      const projB =
        projects.find((p) => p["Project_ID"] === slotBId) ||
        projects[projects.length - 1];

      renderProjectCard("A", projA);
      renderProjectCard("B", projB);
    }

    function renderProjectCard(slot, p) {
      if (!p) return;

      const prefix = slot === "A" ? "projA" : "projB";

      const nameEl = document.getElementById(`${prefix}-name`);
      const stageEl = document.getElementById(`${prefix}-stage`);
      const datesEl = document.getElementById(`${prefix}-dates`);
      const durEl = document.getElementById(`${prefix}-duration`);
      const progFillEl = document.getElementById(`${prefix}-progress-fill`);
      const progLabelEl = document.getElementById(`${prefix}-progress-label`);
      const r1Badge = document.getElementById(`${prefix}-risk1-badge`);
      const r2Badge = document.getElementById(`${prefix}-risk2-badge`);
      const r1LevelEl = document.getElementById(`${prefix}-risk1-level`);
      const r2LevelEl = document.getElementById(`${prefix}-risk2-level`);
      const r1NoteEl = document.getElementById(`${prefix}-risk1-note`);
      const r2NoteEl = document.getElementById(`${prefix}-risk2-note`);

      const startDate = p["Start_Date"] || "";
      const duration = Number(p["Planned_Duration"] || 0);
      const actualProg = Number(p["Actual_Progress"] || 0);
      const plannedProg = Number(p["Planned_Progress"] || 0);
      const risk1Level = p["Risk1_level"] || "";
      const risk2Level = p["Risk2_level"] || "";

      nameEl.textContent = p["Project_Name"] || "—";
      stageEl.textContent = p["Stage_text"] || "—";
      datesEl.textContent = startDate ? `Start: ${startDate}` : "Start: —";
      durEl.textContent = duration
        ? `Duration: ${duration} days`
        : "Duration: —";

      const width = Math.max(0, Math.min(100, actualProg));
      progFillEl.style.width = width + "%";
      progLabelEl.textContent = `${actualProg || 0}% / ${plannedProg || 0}%`;

      r1Badge.className = "risk-badge " + riskClass(risk1Level);
      r2Badge.className = "risk-badge " + riskClass(risk2Level);

      r1LevelEl.textContent = risk1Level || "—";
      r2LevelEl.textContent = risk2Level || "—";
      r1NoteEl.textContent = p["Risk1_Note"] || "—";
      r2NoteEl.textContent = p["Risk2_Note"] || "—";
    }

    // ===== آخر تحديث =====
    function updateLastUpdate() {
      const el = document.getElementById("last-update");
      const now = new Date();
      const formatter = new Intl.DateTimeFormat("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
      el.textContent = "Last update: " + formatter.format(now);
    }

    // ===== تشغيل كل شيء =====
    (async function init() {
      updateLastUpdate();
      await Promise.all([loadData1(), loadProjects()]);
    })();
  </script>
</body>
</html>
