<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FACC — First Avenue Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts (يمكن تغييرها لاحقًا إذا أحببت) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      /* خلفية رئيسية داكنة قريبة من لون الشعار */
      --bg-dark: #022839;
      --bg-dark-soft: #04323b;
      --bg-card: #06414c;
      --turquoise-soft: #0a7a75;
      --turquoise-soft-2: #34c7c5;
      --gold: #c5a56c;
      --text-main: #f5f7f8;
      --text-muted: #aab3bb;
      --danger: #ff5f5b;
      --warning: #ffc857;
      --success: #2dc778;
      --shadow-soft: 0 22px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 28px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #06414c, #02151b 52%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }

    .page {
      width: 100%;
      max-width: 1440px;
      padding: 28px 32px 40px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    /* شعار corner seal في الركن السفلي الأيسر */
    .corner-seal {
      position: fixed;
      left: 22px;
      bottom: 22px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #ffffff10;
      box-shadow: 0 0 0 2px #ffffff22, 0 14px 28px rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      z-index: 9999;
    }

    .corner-seal img {
      width: 52px;
      height: 52px;
      object-fit: contain;
      filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.8));
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-kicker {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--turquoise-soft-2);
    }

    .brand-title {
      font-size: 26px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .last-update-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(
        135deg,
        rgba(20, 141, 119, 0.2),
        rgba(0, 0, 0, 0.5)
      );
      border: 1px solid #2ad1b166;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.5);
      font-size: 11px;
    }

    .dot-live {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 0 rgba(45, 199, 120, 0.8);
      animation: pulse 1.6s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(45, 199, 120, 0.8);
      }
      70% {
        transform: scale(1.25);
        box-shadow: 0 0 0 10px rgba(45, 199, 120, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(45, 199, 120, 0);
      }
    }

    .last-update-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .last-update-value {
      font-weight: 500;
    }

    .top-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .version-tag {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ffffff11;
      color: var(--text-muted);
      background: #00000033;
    }

    /* LAYOUT GRID */
    .main-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.2fr;
      gap: 22px;
      align-items: flex-start;
    }

    .card {
      background: radial-gradient(circle at top left, #06414c, #021820);
      border-radius: var(--radius-lg);
      padding: 20px 22px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      border: 1px solid #ffffff14;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top right,
        rgba(255, 255, 255, 0.06),
        transparent 60%
      );
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border: 1px solid transparent;
      background: #ffffff0d;
    }

    .pill-green {
      color: #0df0a0;
      border-color: #0df0a066;
      background: linear-gradient(
        135deg,
        rgba(0, 176, 116, 0.26),
        rgba(0, 0, 0, 0.7)
      );
    }

    .pill-amber {
      color: var(--warning);
      border-color: #ffc85788;
      background: linear-gradient(
        135deg,
        rgba(255, 200, 87, 0.25),
        rgba(0, 0, 0, 0.7)
      );
    }

    .pill-red {
      color: var(--danger);
      border-color: #ff5f5b88;
      background: linear-gradient(
        135deg,
        rgba(255, 95, 91, 0.28),
        rgba(0, 0, 0, 0.7)
      );
    }

    /* CASH OVERVIEW */
    .cash-main-value {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .cash-main-currency {
      font-size: 13px;
      color: var(--text-muted);
    }

    .cash-grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 18px;
      margin-top: 12px;
    }

    .cash-caption {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 320px;
      line-height: 1.5;
    }

    .chip-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      background: #00000048;
      border: 1px solid #ffffff14;
      font-size: 12px;
    }

    .chip-label {
      color: var(--text-muted);
    }

    .chip-value {
      font-weight: 500;
    }

    /* BUDGET & VARIANCE */
    .budget-main-value {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .budget-caption {
      font-size: 12px;
      color: var(--text-muted);
      max-width: 360px;
    }

    .budget-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 18px;
      margin-top: 14px;
      align-items: stretch;
    }

    .stat-block {
      background: #00000040;
      border-radius: var(--radius-md);
      padding: 10px 14px;
      border: 1px solid #ffffff1a;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .stat-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 500;
    }

    .stat-foot {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .stat-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #ffffff22;
      font-size: 10px;
      text-transform: uppercase;
    }

    .variance-positive {
      color: var(--success);
    }

    .variance-negative {
      color: var(--danger);
    }

    /* 6-month cashflow projection */
    .projection-card {
      background: #00000040;
      border-radius: var(--radius-md);
      padding: 12px 14px 14px;
      border: 1px solid #ffffff1a;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .projection-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 11px;
      color: var(--text-muted);
    }

    .projection-chart {
      height: 120px;
      border-radius: 16px;
      background: radial-gradient(circle at top, #0a2c36, #010b11 70%);
      padding: 10px 12px;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .projection-bar {
      flex: 1;
      border-radius: 999px;
      overflow: hidden;
      background: #ffffff10;
      position: relative;
    }

    .projection-bar-fill {
      position: absolute;
      inset: auto 0 0;
      height: 0;
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        #34c7c5,
        #0a7a75 55%,
        #ff5f5b 100%
      );
      transition: height 600ms ease-out;
    }

    .projection-bar-label {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      color: #ffffffcc;
    }

    .projection-month {
      font-size: 9px;
      text-align: center;
      margin-top: 4px;
      color: var(--text-muted);
    }

    /* PROJECTS SNAPSHOT */
    .projects-card {
      margin-top: 4px;
    }

    .projects-header-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 6px;
    }

    .projects-caption {
      font-size: 12px;
      color: var(--text-muted);
    }

    .projects-body {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .project-slot-labels {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    .slot-pill {
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid #ffffff14;
      font-size: 11px;
      background: #00000055;
      cursor: default;
    }

    .slot-pill span {
      opacity: 0.7;
    }

    .project-card {
      border-radius: var(--radius-md);
      padding: 14px 16px 14px;
      background: linear-gradient(
        135deg,
        rgba(5, 64, 79, 0.96),
        rgba(0, 0, 0, 0.9)
      );
      border: 1px solid #ffffff26;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.7);
      position: relative;
      overflow: hidden;
    }

    .project-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top right,
        rgba(255, 255, 255, 0.06),
        transparent 60%
      );
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .project-card:hover::after {
      opacity: 1;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .project-name {
      font-size: 15px;
      font-weight: 500;
    }

    .project-phase {
      font-size: 11px;
      color: var(--text-muted);
    }

    .project-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 10px;
    }

    .project-meta span strong {
      color: #ffffffde;
      font-weight: 500;
    }

    .progress-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 64px;
    }

    .progress-track {
      position: relative;
      flex: 1;
      height: 7px;
      border-radius: 999px;
      background: #ffffff14;
      overflow: hidden;
    }

    .progress-bar-actual,
    .progress-bar-plan {
      position: absolute;
      top: 0;
      left: 0;
      height: 7px;
      border-radius: 999px;
    }

    .progress-bar-actual {
      background: linear-gradient(90deg, #34c7c5, #0a7a75);
    }

    .progress-bar-plan {
      background: linear-gradient(90deg, #ffc857, #ff9f1c);
      opacity: 0.6;
    }

    .progress-values {
      font-size: 11px;
      min-width: 70px;
      text-align: right;
    }

    .risk-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
      font-size: 11px;
    }

    .risk-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      background: #00000066;
      border: 1px solid #ffffff22;
    }

    .risk-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--warning);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.6);
    }

    .risk-high .risk-dot {
      background: var(--danger);
    }

    .risk-medium .risk-dot {
      background: var(--warning);
    }

    .risk-low .risk-dot {
      background: var(--success);
    }

    .risk-note {
      color: var(--text-muted);
    }

    /* CEO ADMIN FOOTER */
    .admin-card {
      margin-top: 4px;
    }

    .admin-body {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .admin-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .admin-pill {
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px dashed #ffffff33;
      font-size: 11px;
    }

    .admin-note {
      font-size: 10px;
      opacity: 0.8;
    }

    /* RESPONSIVE */
    @media (max-width: 1100px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .page {
        padding: 18px 14px 26px;
      }
      .brand-title {
        font-size: 20px;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .corner-seal {
        display: none; /* نسخة الموبايل لاحقاً لها تصميمها */
      }
    }
  </style>

  <!-- Google Charts loader لاستخدام Google Visualization API -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <!-- Corner seal (الصورة موجودة في المستودع باسم seal.png) -->
  <div class="corner-seal">
    <img src="seal.png" alt="FACC Seal" />
  </div>

  <main class="page">
    <header class="header">
      <div class="brand">
        <div class="brand-kicker">
          FIRST AVENUE FOR INVESTMENT | الجادة الأولى للاستثمار
        </div>
        <h1 class="brand-title">FACC — COMMAND CENTER</h1>
        <div class="brand-subtitle">
          Live snapshot for cash, budget & projects · لمحة حية عن السيولة
          والمشاريع
        </div>
      </div>

      <div class="top-meta">
        <div class="last-update-badge">
          <span class="dot-live"></span>
          <span class="last-update-label">Last update</span>
          <span id="last-update-value" class="last-update-value">—</span>
        </div>
        <span class="version-tag">v1.0 · Desktop dashboard</span>
      </div>
    </header>

    <section class="main-grid">
      <!-- CASH & BUDGET COLUMN -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">CASH OVERVIEW · السيولة النقدية</div>
            <div class="card-subtitle">
              Bank balance after latest payments · رصيد النقد بعد آخر المدفوعات
            </div>
          </div>
          <span id="cash-status-pill" class="pill pill-green">HEALTHY</span>
        </div>

        <div>
          <div class="cash-main-value" id="cash-main-value">
            704,779.76 <span class="cash-main-currency">SAR</span>
          </div>
        </div>

        <div class="cash-grid">
          <p class="cash-caption">
            Cash is higher than short-term obligations خلال 30 يوم. هذه النظرة
            تستخدم بيانات شيت <strong>Data1</strong> (الصف الأحدث).
          </p>

          <div class="chip-stack">
            <div class="chip">
              <span class="chip-label">Pending payments</span>
              <span class="chip-value" id="chip-pending">2,000 SAR</span>
            </div>
            <div class="chip">
              <span class="chip-label">30-day obligations</span>
              <span class="chip-value" id="chip-obligations">41,501.42 SAR</span>
            </div>
            <div class="chip">
              <span class="chip-label">Coverage ratio (Cash / 30D)</span>
              <span class="chip-value" id="chip-coverage">—</span>
            </div>
          </div>
        </div>

        <div class="budget-grid" style="margin-top: 20px">
          <div>
            <div class="card-title" style="margin-bottom: 4px">
              BUDGET & VARIANCE 2026 · ميزانية ٢٠٢٦
            </div>
            <div class="budget-caption">
              View approved budget مقابل المصروف الفعلي وحد الصرف الشهري
              (Cap/month).
            </div>

            <div class="stat-block" style="margin-top: 10px">
              <div class="stat-label">Approved budget (YEAR 2026)</div>
              <div class="stat-value" id="budget-total">3,269,785 SAR</div>
              <div class="stat-foot">
                <span id="budget-ytd-label">Actual spend YTD</span>
                <span id="budget-ytd-value">0 SAR</span>
              </div>
            </div>

            <div class="stat-block" style="margin-top: 8px">
              <div class="stat-label">Monthly cap (auto control)</div>
              <div class="stat-value" id="cap-month">60,310 SAR</div>
              <div class="stat-foot">
                <span id="variance-label">Variance vs cap</span>
                <span
                  id="variance-value"
                  class="variance-positive stat-pill"
                ></span>
              </div>
            </div>
          </div>

          <div class="projection-card">
            <div class="projection-header">
              <span>Cash-flow projection · توقع السيولة (6 أشهر)</span>
              <span id="projection-summary">—</span>
            </div>

            <div id="projection-chart" class="projection-chart">
              <!-- ستُملأ ديناميكياً -->
            </div>
          </div>
        </div>
      </section>

      <!-- PROJECTS & ADMIN COLUMN -->
      <section>
        <section class="card projects-card">
          <div class="card-header">
            <div>
              <div class="card-title">
                PROJECTS SNAPSHOT · مشاريع قيد التنفيذ
              </div>
              <div class="card-subtitle">
                عرض لمشروعين في آن واحد (Slot A & B). التبديل بين المشاريع يتم
                من لوحة التحكم لاحقاً.
              </div>
            </div>
          </div>

          <div class="projects-header-line">
            <div class="project-slot-labels">
              <div class="slot-pill">
                Slot A · <span id="slot-a-label">Project 1</span>
              </div>
              <div class="slot-pill">
                Slot B · <span id="slot-b-label">Project 2</span>
              </div>
            </div>
          </div>

          <div class="projects-body">
            <!-- Project A -->
            <article class="project-card" id="project-card-a">
              <div class="project-header">
                <div>
                  <div class="project-name" id="proj-a-name">Business Front</div>
                  <div class="project-phase" id="proj-a-stage">
                    Design & licensing
                  </div>
                </div>
                <span class="pill pill-amber" id="proj-a-phase-pill"
                  >ON PLAN</span
                >
              </div>

              <div class="project-meta" id="proj-a-meta">
                <!-- filled by JS -->
              </div>

              <div class="progress-row">
                <div class="progress-label">Progress</div>
                <div class="progress-track">
                  <div
                    id="proj-a-progress-actual"
                    class="progress-bar-actual"
                    style="width: 60%"
                  ></div>
                  <div
                    id="proj-a-progress-plan"
                    class="progress-bar-plan"
                    style="width: 72%"
                  ></div>
                </div>
                <div class="progress-values" id="proj-a-progress-labels">
                  60% / 72%
                </div>
              </div>

              <div class="risk-row" id="proj-a-risks">
                <!-- risks -->
              </div>
            </article>

            <!-- Project B -->
            <article class="project-card" id="project-card-b">
              <div class="project-header">
                <div>
                  <div class="project-name" id="proj-b-name">Jada School</div>
                  <div class="project-phase" id="proj-b-stage">
                    Design & licensing
                  </div>
                </div>
                <span class="pill pill-green" id="proj-b-phase-pill"
                  >EARLY PHASE</span
                >
              </div>

              <div class="project-meta" id="proj-b-meta">
                <!-- filled by JS -->
              </div>

              <div class="progress-row">
                <div class="progress-label">Progress</div>
                <div class="progress-track">
                  <div
                    id="proj-b-progress-actual"
                    class="progress-bar-actual"
                    style="width: 10%"
                  ></div>
                  <div
                    id="proj-b-progress-plan"
                    class="progress-bar-plan"
                    style="width: 30%"
                  ></div>
                </div>
                <div class="progress-values" id="proj-b-progress-labels">
                  10% / 30%
                </div>
              </div>

              <div class="risk-row" id="proj-b-risks">
                <!-- risks -->
              </div>
            </article>
          </div>
        </section>

        <section class="card admin-card">
          <div class="card-header">
            <div>
              <div class="card-title">
                CEO CONTROLS (ADMIN) · لوحة تحكم الرئيس التنفيذي
              </div>
              <div class="card-subtitle">
                التعديل على المشاريع يتم من واجهة الداشبورد (Desktop only) ثم
                تُرسل التحديثات إلى شيت
                <strong>Projects</strong> وتنعكس على نسخة الجوال لاحقاً.
              </div>
            </div>
            <span class="pill">DESKTOP ONLY</span>
          </div>

          <div class="admin-body">
            <div class="admin-row">
              <div class="admin-pill">
                Stage, Start date, Duration, Actual/Planned progress
              </div>
              <div class="admin-pill">
                Risk 1 &amp; 2 (level + notes) مع امكانية تبديل المشاريع في Slot
                A / B
              </div>
            </div>
            <p class="admin-note" style="margin-top: 10px">
              * حالياً يتم قراءة البيانات فقط من Google Sheets (من دون كتابة).
              في الإصدار القادم سنضيف لوحة تحكم فعلية تكتب إلى الشيت مباشرة
              ثم تنعكس على نسخة الجوال.
            </p>
          </div>
        </section>
      </section>
    </section>
  </main>

  <script>
    // ========= إعداد Google Sheets =========
    // ضع هنا الـ Sheet ID الخاص بك (هو الموجود في الرابط)
    const SHEET_ID = "14Z3TPLYq5ufs2lTX_qkeDsV2inZeFwfMwwG9NMQQwHc";
    const DATA1_RANGE = "Data1!A1:J200";
    const PROJECTS_RANGE = "Projects!A1:K50";

    // مراجع للعناصر في الصفحة
    const cashMainEl = document.getElementById("cash-main-value");
    const pendingEl = document.getElementById("chip-pending");
    const obligEl = document.getElementById("chip-obligations");
    const coverageEl = document.getElementById("chip-coverage");
    const cashStatusPill = document.getElementById("cash-status-pill");

    const budgetTotalEl = document.getElementById("budget-total");
    const budgetYtdValueEl = document.getElementById("budget-ytd-value");
    const varianceLabelEl = document.getElementById("variance-label");
    const varianceValueEl = document.getElementById("variance-value");
    const capMonthEl = document.getElementById("cap-month");
    const projectionChartEl = document.getElementById("projection-chart");
    const projectionSummaryEl =
      document.getElementById("projection-summary");
    const lastUpdateEl = document.getElementById("last-update-value");

    const slotALabel = document.getElementById("slot-a-label");
    const slotBLabel = document.getElementById("slot-b-label");

    // عناصر مشروع A
    const projA = {
      name: document.getElementById("proj-a-name"),
      stage: document.getElementById("proj-a-stage"),
      meta: document.getElementById("proj-a-meta"),
      progressActual: document.getElementById("proj-a-progress-actual"),
      progressPlan: document.getElementById("proj-a-progress-plan"),
      progressLabels: document.getElementById("proj-a-progress-labels"),
      risks: document.getElementById("proj-a-risks"),
      phasePill: document.getElementById("proj-a-phase-pill"),
    };

    // عناصر مشروع B
    const projB = {
      name: document.getElementById("proj-b-name"),
      stage: document.getElementById("proj-b-stage"),
      meta: document.getElementById("proj-b-meta"),
      progressActual: document.getElementById("proj-b-progress-actual"),
      progressPlan: document.getElementById("proj-b-progress-plan"),
      progressLabels: document.getElementById("proj-b-progress-labels"),
      risks: document.getElementById("proj-b-risks"),
      phasePill: document.getElementById("proj-b-phase-pill"),
    };

    // تنسيق أرقام بالريال
    function fmtSar(num) {
      if (num === null || num === undefined || isNaN(num)) return "0 SAR";
      return (
        num.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }) + " SAR"
      );
    }

    function fmtPercent(num) {
      if (num === null || num === undefined || isNaN(num)) return "0%";
      return num.toFixed(0) + "%";
    }

    // ======== دوال تعبئة الداشبورد من البيانات الخام ========

    function updateCashAndBudgetFromData1(rows) {
      // rows: مصفوفة أسطر من Data1 بدون الهيدر
      // نبحث عن آخر صف فيه Cash_Balance (الصف الأحدث)
      let latestRow = null;
      for (const row of rows) {
        const cash = row[1]; // B = Cash_Balance
        if (cash !== null && cash !== "") {
          latestRow = row;
          break; // لأن البيانات مرتبة تنازلياً (DEC-25 ثم JAN-26 ...)
        }
      }
      if (!latestRow) return;

      const cashBalance = Number(latestRow[1]) || 0;
      const pending = Number(latestRow[2]) || 0;
      const obligation30 = Number(latestRow[3]) || 0;

      // Budget_Total: نأخذ أول قيمة غير صفرية في عمود E
      let budgetTotal = 0;
      for (const row of rows) {
        const val = Number(row[4]) || 0;
        if (val > 0) {
          budgetTotal = val;
          break;
        }
      }

      // Actual_Expense YTD = مجموع عمود I لكل الشهور التي فيها صرف فعلي
      let actualYtd = 0;
      for (const row of rows) {
        const exp = Number(row[8]) || 0;
        actualYtd += exp;
      }

      const coverage =
        obligation30 > 0 ? (cashBalance / obligation30) * 1.0 : null;

      // Cap per month = budget / 12 (يمكن تعديل المعادلة لاحقاً)
      const capMonth = budgetTotal > 0 ? budgetTotal / 12 : 0;

      // variance مقابل Cap هذا الشهر = (Cap - Actual_Expense لأحدث شهر)
      const latestActual = Number(latestRow[8]) || 0;
      const variance = capMonth - latestActual;

      // تعبئة العناصر
      cashMainEl.innerHTML =
        cashBalance.toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }) + ' <span class="cash-main-currency">SAR</span>';

      pendingEl.textContent = fmtSar(pending);
      obligEl.textContent = fmtSar(obligation30);

      if (coverage !== null) {
        coverageEl.textContent = coverage.toFixed(2) + "×";
      } else {
        coverageEl.textContent = "—";
      }

      // حالة السيولة حسب نسبة التغطية
      if (coverage >= 3) {
        cashStatusPill.textContent = "COMFORTABLE";
        cashStatusPill.className = "pill pill-green";
      } else if (coverage >= 1.2) {
        cashStatusPill.textContent = "STABLE";
        cashStatusPill.className = "pill pill-amber";
      } else {
        cashStatusPill.textContent = "TIGHT";
        cashStatusPill.className = "pill pill-red";
      }

      budgetTotalEl.textContent = fmtSar(budgetTotal);
      budgetYtdValueEl.textContent = fmtSar(actualYtd);

      capMonthEl.textContent = fmtSar(capMonth);

      if (variance >= 0) {
        varianceLabelEl.textContent = "Room vs monthly cap";
        varianceValueEl.textContent = fmtSar(variance);
        varianceValueEl.classList.remove("variance-negative");
        varianceValueEl.classList.add("variance-positive");
      } else {
        varianceLabelEl.textContent = "Over monthly cap";
        varianceValueEl.textContent = fmtSar(Math.abs(variance));
        varianceValueEl.classList.remove("variance-positive");
        varianceValueEl.classList.add("variance-negative");
      }

      // تحديث حقل "آخر تحديث" من تاريخ اليوم (يمكن تعديله لاحقاً ليقرأ من الشيت)
      const now = new Date();
      lastUpdateEl.textContent = now.toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });

      // إعداد توقع التدفقات النقدية 6 أشهر
      buildCashflowProjection(rows, latestRow, cashBalance);
    }

    function buildCashflowProjection(rows, latestRow, startingCash) {
      // نحدد index الصف الحالي
      const idx = rows.indexOf(latestRow);
      const horizonRows = rows.slice(idx, idx + 7); // شهر حالي + 6 بعده

      const points = [];
      let running = startingCash;
      for (let i = 0; i < horizonRows.length; i++) {
        const r = horizonRows[i];
        const monthLabel = r[0] || "";
        const incF = Number(r[5]) || 0; // Income_Forcast
        const expF = Number(r[6]) || 0; // Expense_Forcast
        if (i > 0) {
          // من الشهر القادم نضيف/نطرح الصافي
          running += incF - expF;
        }
        points.push({
          month: String(monthLabel),
          cash: running,
        });
      }

      // ملخص سريع
      if (points.length > 1) {
        const start = points[0].cash;
        const end = points[points.length - 1].cash;
        const diff = end - start;
        const dir = diff >= 0 ? "up" : "down";
        projectionSummaryEl.textContent = `${
          dir === "up" ? "▲" : "▼"
        } ${fmtSar(Math.abs(diff))} over 6 months`;
        projectionSummaryEl.style.color =
          diff >= 0 ? "var(--success)" : "var(--danger)";
      }

      // رسم الأعمدة
      projectionChartEl.innerHTML = "";
      if (points.length <= 1) return;

      const maxCash = Math.max(...points.map((p) => p.cash));
      const minCash = Math.min(...points.map((p) => p.cash));
      const span = maxCash - minCash || 1;

      points.forEach((p, idx) => {
        const wrapper = document.createElement("div");
        wrapper.style.flex = "1";
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.alignItems = "stretch";

        const bar = document.createElement("div");
        bar.className = "projection-bar";

        const fill = document.createElement("div");
        fill.className = "projection-bar-fill";

        const normalized = (p.cash - minCash) / span;
        const height = 20 + normalized * 70; // من 20% إلى 90%
        fill.style.height = height + "%";

        const label = document.createElement("div");
        label.className = "projection-bar-label";
        label.textContent = (p.cash / 1000).toFixed(0) + "k";

        bar.appendChild(fill);
        bar.appendChild(label);

        const month = document.createElement("div");
        month.className = "projection-month";
        month.textContent = p.month || `M${idx + 1}`;

        wrapper.appendChild(bar);
        wrapper.appendChild(month);
        projectionChartEl.appendChild(wrapper);
      });
    }

    function mapRiskLevelToClass(level) {
      if (!level) return "risk-medium";
      const v = String(level).toLowerCase();
      if (v.startsWith("h")) return "risk-high";
      if (v.startsWith("l")) return "risk-low";
      return "risk-medium";
    }

    function fillProjectCard(card, row) {
      const [
        projectId,
        projectName,
        stageText,
        startDate,
        plannedDuration,
        actualProgress,
        plannedProgress,
        risk1Level,
        risk1Note,
        risk2Level,
        risk2Note,
      ] = row;

      card.name.textContent = projectName || "—";
      card.stage.textContent = stageText || "";

      // meta
      const startStr = startDate ? String(startDate) : "—";
      const durStr = plannedDuration ? plannedDuration + " days" : "—";
      card.meta.innerHTML = `
        <span><strong>Start:</strong> ${startStr}</span>
        <span><strong>Duration:</strong> ${durStr}</span>
      `;

      const actual = Number(actualProgress) || 0;
      const plan = Number(plannedProgress) || 0;

      const actualPct = Math.max(0, Math.min(100, actual));
      const planPct = Math.max(0, Math.min(100, plan));

      card.progressActual.style.width = actualPct + "%";
      card.progressPlan.style.width = planPct + "%";
      card.progressLabels.textContent =
        fmtPercent(actualPct) + " / " + fmtPercent(planPct);

      // Phase pill (بسيطة: حسب الفرق بين actual و planned)
      const delta = actualPct - planPct;
      if (delta >= -5 && delta <= 5) {
        card.phasePill.textContent = "ON PLAN";
        card.phasePill.className = "pill pill-amber";
      } else if (delta > 5) {
        card.phasePill.textContent = "AHEAD";
        card.phasePill.className = "pill pill-green";
      } else {
        card.phasePill.textContent = "DELAYED";
        card.phasePill.className = "pill pill-red";
      }

      // Risks
      card.risks.innerHTML = "";

      if (risk1Level || risk1Note) {
        const pill1 = document.createElement("div");
        pill1.className =
          "risk-pill " + mapRiskLevelToClass(risk1Level || "medium");
        pill1.innerHTML = `
          <span class="risk-dot"></span>
          <span><strong>Risk 1:</strong> ${risk1Level || ""}</span>
          <span class="risk-note">${risk1Note || ""}</span>
        `;
        card.risks.appendChild(pill1);
      }

      if (risk2Level || risk2Note) {
        const pill2 = document.createElement("div");
        pill2.className =
          "risk-pill " + mapRiskLevelToClass(risk2Level || "medium");
        pill2.innerHTML = `
          <span class="risk-dot"></span>
          <span><strong>Risk 2:</strong> ${risk2Level || ""}</span>
          <span class="risk-note">${risk2Note || ""}</span>
        `;
        card.risks.appendChild(pill2);
      }
    }

    function updateProjectsFromSheet(rows) {
      if (!rows || rows.length === 0) return;

      // نفترض أن الصف الأول بعد الهيدر هو Project 1 والثاني Project 2
      const projARow = rows[0] || [];
      const projBRow = rows[1] || rows[0] || [];

      slotALabel.textContent = projARow[1] || "Project A";
      slotBLabel.textContent = projBRow[1] || "Project B";

      fillProjectCard(projA, projARow);
      fillProjectCard(projB, projBRow);
    }

    // ========== تحميل البيانات من Google Sheets ==========

    function loadFromSheets() {
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(() => {
        // نستخدم Visualization API لقراءة النطاقين
        const base =
          "https://docs.google.com/spreadsheets/d/" +
          SHEET_ID +
          "/gviz/tq?";

        const data1Query = new google.visualization.Query(
          base + "sheet=Data1&range=A1:J200"
        );
        const projectsQuery = new google.visualization.Query(
          base + "sheet=Projects&range=A1:K50"
        );

        data1Query.send((response) => {
          if (response.isError()) {
            console.warn("Data1 error, using fallback demo data.");
            useFallbackDemoData();
            return;
          }
          const table = response.getDataTable();
          const rows = [];
          for (let r = 1; r < table.getNumberOfRows(); r++) {
            const row = [];
            for (let c = 0; c < table.getNumberOfColumns(); c++) {
              row.push(table.getValue(r, c));
            }
            rows.push(row);
          }
          updateCashAndBudgetFromData1(rows);
        });

        projectsQuery.send((response) => {
          if (response.isError()) {
            console.warn("Projects error, using fallback demo projects.");
            useFallbackDemoProjects();
            return;
          }
          const table = response.getDataTable();
          const rows = [];
          for (let r = 1; r < table.getNumberOfRows(); r++) {
            const row = [];
            for (let c = 0; c < table.getNumberOfColumns(); c++) {
              row.push(table.getValue(r, c));
            }
            rows.push(row);
          }
          updateProjectsFromSheet(rows);
        });
      });
    }

    // ========== بيانات افتراضية في حال لم يعمل الربط ==========

    function useFallbackDemoData() {
      const rows = [
        // Month, Cash_Balance, Pending, Obligation_30D, Budget_Total, Income_Forecast, Expense_Forecast, Income_Month, Actual_Expense, (col J فارغ)
        [
          "DEC-25",
          704779.76,
          2000,
          41501.42,
          0,
          747500,
          60310,
          60310,
          0,
          null,
        ],
        ["JAN-26", null, null, null, 3269785, 287500, 260310, 60310, 0, null],
        ["FEB-26", null, null, null, 0, 415984, 60310, 60310, 0, null],
        ["MAR-26", null, null, null, 0, 0, 60310, 60310, 0, null],
        ["APR-26", null, null, null, 0, 0, 60310, 60310, 0, null],
        ["MAY-26", null, null, null, 0, 0, 60310, 60310, 0, null],
        ["JUN-26", null, null, null, 0, 0, 60310, 60310, 0, null],
      ];
      updateCashAndBudgetFromData1(rows);
    }

    function useFallbackDemoProjects() {
      const rows = [
        [
          1,
          "Business Front",
          "Design & licensing",
          "25-Sep-2025",
          120,
          60,
          72,
          "High",
          "Schedule delay",
          "Medium",
          "Parking requirement",
        ],
        [
          2,
          "Jada School",
          "Design & licensing",
          "28-Dec-2024",
          180,
          10,
          30,
          "High",
          "Municipality approval",
          "High",
          "Schedule delay",
        ],
      ];
      updateProjectsFromSheet(rows);
    }

    // تشغيل
    (function init() {
      try {
        loadFromSheets();
      } catch (e) {
        console.warn("Sheets load failed, using fallback demo.", e);
        useFallbackDemoData();
        useFallbackDemoProjects();
      }
    })();
  </script>
</body>
</html>
