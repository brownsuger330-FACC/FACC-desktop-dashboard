<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>FACC — First Avenue Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
  <style>
    :root {
      --bg-dark: #02282f;
      --card-dark: #063540;
      --card-darker: #032027;
      --turquoise: #11c5c6;
      --turquoise-soft: #54d3d4;
      --accent-gold: #c5a56c;
      --accent-red: #ff5560;
      --accent-yellow: #f4c95d;
      --accent-green: #2ecc71;
      --text-main: #ffffff;
      --text-muted: #9fb4c0;
      --border-subtle: rgba(255,255,255,0.04);
      --shadow-soft: 0 14px 45px rgba(0,0,0,0.55);
      --radius-lg: 22px;
      --radius-md: 18px;
    }
 
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
 
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left,#09414c 0%,#01161c 52%,#000b0f 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }
 
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 26px 32px 40px;
      gap: 22px;
    }
 
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }
 
    .brand-block {
      display: flex;
      align-items: center;
      gap: 18px;
    }
 
    .logo-seal {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 0 1px rgba(5, 201, 201, 0.4);
      background: radial-gradient(circle at 30% 30%, #ffffff 0, #f5f7f8 35%, #dde3e8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
 
    .logo-seal img {
      width: 135%;
      height: auto;
      object-fit: cover;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.5));
      transform: translateY(1px);
    }
 
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
 
    .title-main {
      font-size: 22px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #f5f8f9;
    }
 
    .title-sub {
      font-size: 15px;
      color: var(--turquoise-soft);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }
 
    .title-ar {
      font-size: 13px;
      color: var(--text-muted);
    }
 
    .header-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(120deg, #08414b, #022026);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
    }
 
    .header-badge-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 8px rgba(46, 204, 113,0.9);
    }
 
    .header-badge-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      color: var(--text-muted);
    }
 
    .header-badge-value {
      font-size: 12px;
      color: #f3fafc;
    }
 
    .grid-main {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      align-items: flex-start;
      gap: 20px;
      flex: 1;
      min-height: 0;
    }
 
    .col {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
 
    .card {
      background: radial-gradient(circle at top left, #094652 0%, #041c22 65%, #021115 100%);
      border-radius: var(--radius-lg);
      padding: 18px 20px 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      transition:
        transform 160ms ease-out,
        box-shadow 160ms ease-out,
        border-color 160ms ease-out,
        background 200ms ease-out;
    }
 
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.06), transparent 55%),
        radial-gradient(circle at bottom right, rgba(17,197,198,0.12), transparent 60%);
      opacity: 0;
      transition: opacity 220ms ease-out;
      pointer-events: none;
    }
 
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.85);
      border-color: rgba(17,197,198,0.4);
      background: radial-gradient(circle at top left, #0b5663 0%, #031a20 65%, #010b0f 100%);
    }
 
    .card:hover::before {
      opacity: 1;
    }
 
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
 
    .card-title {
      font-size: 13px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
 
    .kpi-chip {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.28);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
 
    .chip-green {
      color: var(--accent-green);
      border-color: rgba(46, 204, 113, 0.6);
      box-shadow: 0 0 0 1px rgba(46, 204, 113, 0.2);
    }
 
    .chip-amber {
      color: var(--accent-yellow);
      border-color: rgba(244, 201, 93, 0.6);
      box-shadow: 0 0 0 1px rgba(244, 201, 93, 0.2);
    }
 
    .chip-red {
      color: var(--accent-red);
      border-color: rgba(255, 85, 96, 0.7);
      box-shadow: 0 0 0 1px rgba(255, 85, 96, 0.25);
    }
 
    .kpi-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin: 4px 0 4px;
    }
 
    .kpi-value {
      font-size: 26px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
 
    .kpi-unit {
      font-size: 12px;
      color: var(--text-muted);
    }
 
    .kpi-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
 
    .kpi-footer {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
 
    .pill-small {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
    }

    .mini-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
 
    .mini-row strong {
      color: #f6fafc;
    }
 
    .bar-shell {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      overflow: hidden;
      position: relative;
    }
 
    .bar-fill {
      height: 100%;
      width: 62%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--turquoise), var(--turquoise-soft));
      box-shadow: 0 0 12px rgba(17,197,198,0.8);
    }
 
    .bar-tick {
      position: absolute;
      top: -2px;
      width: 2px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent-gold);
      left: 72%;
      box-shadow: 0 0 8px rgba(197,165,108,0.9);
    }

    .variance-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(255,85,96,0.12);
      color: var(--accent-red);
      border: 1px solid rgba(255,85,96,0.45);
    }
 
    .variance-pill span.arrow {
      font-size: 11px;
    }

    .chart-card {
      padding: 18px 20px 18px;
    }
 
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 10px;
    }
 
    .chart-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }
 
    .chart-legend {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 11px;
    }
 
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
 
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
 
    .legend-dot.blue {
      background: var(--turquoise-soft);
      box-shadow: 0 0 10px rgba(84,211,212,0.9);
    }
 
    .legend-dot.gold {
      background: var(--accent-gold);
    }
 
    .chart-body {
      background: radial-gradient(circle at top, #0a3d45 0%, #021117 65%, #00080b 100%);
      border-radius: 18px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(255,255,255,0.04);
      position: relative;
      overflow: hidden;
    }
 
    .chart-grid {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px),
                        linear-gradient(to top, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 52px 26px;
      opacity: 0.7;
      pointer-events: none;
    }
 
    .chart-svg {
      width: 100%;
      max-height: 210px;
      display: block;
      position: relative;
      z-index: 1;
    }
 
    .chart-footer {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }
 
    .chart-footer strong {
      color: #f5fafc;
    }

    .projects-card {
      padding: 16px 18px 16px;
    }
 
    .projects-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
 
    .projects-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }
 
    .projects-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
 
    .select {
      background: rgba(0,0,0,0.45);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 5px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }
 
    .select span {
      font-size: 12px;
      color: #f3fafc;
    }
 
    .select small {
      font-size: 11px;
      color: var(--text-muted);
    }
 
    .project-row {
      padding: 10px 11px 10px;
      border-radius: 14px;
      background: linear-gradient(120deg, rgba(0,0,0,0.24), rgba(0,0,0,0.5));
      border: 1px solid rgba(255,255,255,0.04);
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }
 
    .project-row + .project-row {
      margin-top: 8px;
    }
 
    .project-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
 
    .project-name {
      font-size: 13px;
      font-weight: 500;
    }
 
    .project-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
 
    .project-badges {
      display: flex;
      align-items: center;
      gap: 6px;
    }
 
    .badge-stage {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
      color: var(--turquoise-soft);
      background: rgba(0,0,0,0.35);
    }
 
    .progress-shell {
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
 
    .progress-labels {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 78px;
    }
 
    .progress-bar {
      flex: 1;
      height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      position: relative;
      overflow: hidden;
    }
 
    .progress-fill {
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, var(--turquoise), var(--turquoise-soft));
      border-radius: inherit;
      box-shadow: 0 0 12px rgba(17,197,198,0.9);
    }
 
    .progress-tick {
      position: absolute;
      top: -2px;
      left: 72%;
      width: 2px;
      height: 11px;
      border-radius: 999px;
      background: var(--accent-gold);
      box-shadow: 0 0 8px rgba(197,165,108,0.9);
    }
 
    .progress-percent {
      font-size: 11px;
      min-width: 52px;
      text-align: right;
      color: #f6fafc;
    }
 
    .risk-chips {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }
 
    .risk-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.38);
      color: var(--text-muted);
    }
 
    .risk-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
 
    .risk-dot.red {
      background: var(--accent-red);
      box-shadow: 0 0 8px rgba(255,85,96,0.9);
    }
 
    .risk-dot.yellow {
      background: var(--accent-yellow);
      box-shadow: 0 0 8px rgba(244,201,93,0.9);
    }
 
    .panel-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }
 
    .admin-card {
      padding: 14px 16px 14px;
    }
 
    .admin-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
 
    .btn-ghost {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.4);
      color: #f5fafc;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: default;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
 
    .btn-ghost span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent-gold);
      box-shadow: 0 0 8px rgba(197,165,108,0.85);
    }
 
    .admin-form {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px 10px;
    }
 
    .admin-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
 
    .admin-field label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
 
    .admin-field input,
    .admin-field select,
    .admin-field textarea {
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.38);
      color: #f5fafc;
      padding: 4px 6px;
      font-size: 11px;
      font-family: inherit;
      resize: vertical;
      min-height: 24px;
    }
 
    .admin-field textarea {
      min-height: 40px;
    }
 
    .admin-row-wide {
      grid-column: 1 / -1;
    }
 
    .admin-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 11px;
    }
 
    .btn-apply {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(17,197,198,0.7);
      background: rgba(17,197,198,0.16);
      color: #e8feff;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
    }
 
    .btn-apply:hover {
      background: rgba(17,197,198,0.28);
    }
 
    .admin-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }
 
    @media (max-width: 1200px) {
      .page {
        padding: 18px 20px 26px;
      }
    }
 
    @media (max-width: 1024px) {
      .grid-main {
        grid-template-columns: 1fr;
      }
    }
 
    @media (max-width: 768px) {
      .page {
        padding: 16px;
      }
      .admin-form {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
  </style>
</head>
 
<body>
  <div class="page">
    <header class="header">
      <div class="brand-block">
        <div class="logo-seal">
          <!-- الشعار الحقيقي من الملف seal.png -->
          <img src="seal.png" alt="FACC Seal" />
        </div>
        <div class="title-block">
          <div class="title-sub">First Avenue for Investment</div>
          <div class="title-main">FACC — Command Center</div>
          <div class="title-ar">لوحة قيادة تنفيذية للسيولة والمشاريع والمخاطر</div>
        </div>
      </div>
      <div class="header-badge">
        <div class="header-badge-dot"></div>
        <div>
          <div class="header-badge-label">Live snapshot</div>
          <div class="header-badge-value" id="lastUpdateLabel">
            Pulled from Data1 &amp; Projects (Google Sheets)
          </div>
        </div>
      </div>
    </header>
 
    <main class="grid-main">
      <!-- العمود الأيسر: كاش + ميزانية + كاب + تشارت -->
      <section class="col">
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;">
          <!-- Cash balance -->
          <article class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Cash balance</div>
              </div>
              <div class="kpi-chip chip-green" id="cashStatusChip">Comfortable</div>
            </div>
            <div class="kpi-main">
              <div class="kpi-value" id="cashBalanceValue">—</div>
              <div class="kpi-unit">SAR</div>
            </div>
            <div class="kpi-sub" id="cashSubText">
              الرصيد بعد آخر مدفوعات – أعلى من التزامات 30 يوم القادمة.
            </div>
            <div class="kpi-footer">
              <span class="pill-small" id="obl30dLabel">Obligations 30D: — SAR</span>
              <span class="pill-small" id="pendingLabel">Pending: — SAR</span>
            </div>
          </article>
 
          <!-- Budget control -->
          <article class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Budget control 2026</div>
              </div>
              <div class="kpi-chip chip-amber" id="budgetChip">Monitoring</div>
            </div>
            <div class="kpi-main">
              <div class="kpi-value" id="budgetApproved">—</div>
              <div class="kpi-unit">SAR • Approved budget</div>
            </div>
            <div class="mini-row">
              <span>Actual YTD</span>
              <span><strong id="budgetActual">—</strong> SAR</span>
            </div>
            <div class="mini-row">
              <span>Budget remaining</span>
              <span><strong id="budgetRemaining">—</strong> SAR</span>
            </div>
            <div class="mini-row">
              <span>Variance</span>
              <span class="variance-pill" id="budgetVariance">
                <span class="arrow">▲</span> 0% vs plan
              </span>
            </div>
          </article>
        </div>
 
        <!-- Monthly cap + control status -->
        <div style="display:grid;grid-template-columns:1.15fr .85fr;gap:16px;">
          <article class="card">
            <div class="card-header">
              <div class="card-title">Monthly spending cap</div>
              <div class="kpi-chip chip-green">Auto rule</div>
            </div>
            <div class="kpi-main">
              <div class="kpi-value" id="capValue">200,000</div>
              <div class="kpi-unit">SAR • max monthly</div>
            </div>
            <div class="mini-row">
              <span>Safe envelope</span>
              <div class="bar-shell">
                <div class="bar-fill" id="capBarFill"></div>
                <div class="bar-tick" id="capBarTick"></div>
              </div>
              <span style="font-size:11px;color:var(--text-muted);">Planned pace</span>
            </div>
            <div class="kpi-footer">
              <span class="pill-small" id="capRuleText">
                Rule: 25% of remaining budget / remaining months (max 200k)
              </span>
            </div>
          </article>
 
          <article class="card">
            <div class="card-header">
              <div class="card-title">Control status</div>
              <div class="kpi-chip chip-green" id="controlChip">Healthy</div>
            </div>
            <div class="kpi-main">
              <div class="kpi-value" style="font-size:22px;" id="controlText">Under control</div>
            </div>
            <div class="kpi-sub" id="controlDetails">
              • السيولة تغطي التزامات 30 يوم<br />
              • الانحراف عن الميزانية ضمن النطاق المتفق عليه<br />
              • لا توجد تنبيهات حمراء في الأشهر الستة القادمة
            </div>
          </article>
        </div>
 
        <!-- Cash flow chart -->
        <article class="card chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Cash flow projection — 6 months</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">
                توقع السيولة الصافية بالاعتماد علىIncome_Forcast &amp; Expense_Forcast
              </div>
            </div>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-dot blue"></span>السيولة المتوقعة</span>
              <span class="legend-item"><span class="legend-dot gold"></span>الحد الأدنى الآمن</span>
            </div>
          </div>
          <div class="chart-body">
            <div class="chart-grid"></div>
            <svg class="chart-svg" id="cashChart" viewBox="0 0 420 210" aria-hidden="true">
              <!-- سيتم توليد المسار والنقاط من الجافاسكربت -->
            </svg>
          </div>
          <div class="chart-footer" id="chartComment">
            <strong>تحليل تجريبي:</strong> سيتم توليد التعليق حسب الأرقام الفعلية من الشيت.
          </div>
        </article>
      </section>
 
      <!-- العمود الأيمن: Projects + CEO Control -->
      <section class="col">
        <!-- Projects snapshot -->
        <article class="card projects-card">
          <div class="projects-header">
            <div>
              <div class="projects-title">Projects snapshot</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">
                يعرض مشروعين في آن واحد – يتم تغذيتها من تبويب<strong>Projects</strong>.
              </div>
            </div>
            <div class="projects-filter">
              <span class="panel-label">Smart filter</span>
              <!-- فلتر واحد فقط -->
              <div class="select">
                <span id="projectFilterName">—</span>
                <small id="projectFilterMeta">Primary project</small>
              </div>
            </div>
          </div>
 
          <div id="projectsContainer">
            <!-- سيتم توليد كروت المشاريع من الجافاسكربت -->
          </div>
        </article>
 
        <!-- CEO Controls (Admin) -->
        <article class="card admin-card">
          <div class="card-header" style="margin-bottom:6px;">
            <div class="card-title">CEO controls (Admin)</div>
            <div class="kpi-chip">Desktop only</div>
          </div>
 
          <div style="font-size:12px;color:var(--text-muted);line-height:1.6;margin-bottom:6px;">
            تحكم كامل في بيانات المشروع مباشرة من الداشبورد (محلياً في المتصفح):
          </div>
 
          <div class="admin-form" id="adminForm">
            <div class="admin-field admin-row-wide">
              <label for="adminProjectSelect">Project selector (يرتبط أيضاً بالفلتر أعلاه)</label>
              <select id="adminProjectSelect"></select>
            </div>
 
            <div class="admin-field">
              <label for="adminName">Project name</label>
              <input id="adminName" type="text" />
            </div>
 
            <div class="admin-field">
              <label for="adminStage">Stage text</label>
              <input id="adminStage" type="text" />
            </div>
 
            <div class="admin-field">
              <label for="adminStart">Start date</label>
              <input id="adminStart" type="text" placeholder="25-Sep-2025" />
            </div>
 
            <div class="admin-field">
              <label for="adminDuration">Duration (days)</label>
              <input id="adminDuration" type="number" />
            </div>
 
            <div class="admin-field">
              <label for="adminActual">Actual %</label>
              <input id="adminActual" type="number" min="0" max="100" />
            </div>
 
            <div class="admin-field">
              <label for="adminPlanned">Planned %</label>
              <input id="adminPlanned" type="number" min="0" max="100" />
            </div>
 
            <div class="admin-field">
              <label for="adminRisk1Level">Risk 1 level</label>
              <select id="adminRisk1Level">
                <option value="">(none)</option>
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
 
            <div class="admin-field">
              <label for="adminRisk1Note">Risk 1 note</label>
              <input id="adminRisk1Note" type="text" />
            </div>
 
            <div class="admin-field">
              <label for="adminRisk2Level">Risk 2 level</label>
              <select id="adminRisk2Level">
                <option value="">(none)</option>
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
 
            <div class="admin-field admin-row-wide">
              <label for="adminRisk2Note">Risk 2 note</label>
              <textarea id="adminRisk2Note"></textarea>
            </div>
          </div>
 
          <div class="admin-actions">
            <button class="btn-apply" id="btnApplyChanges">Apply locally</button>
          </div>
 
          <div class="admin-footer">
            <div class="btn-ghost">
              <span class="dot"></span>
              SAMPLE — READ FROM SHEETS / LOCAL WRITE ONLY
            </div>
            <span class="admin-note">
              عند الضغط على <strong>Apply locally</strong>يتم تحديث كروت المشاريع فوراً داخل الداشبورد.
              لربط التغييرات فعلياً مع Google Sheets نضيف لاحقاًGoogle Apps Script آمن.
            </span>
          </div>
        </article>
      </section>
    </main>
  </div>
 
  <script>
    // =============================
    //  إعداد الروابط الثابتة للشيت
    // =============================
    const DATA1_CSV =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=0&single=true&output=csv";
 
    const PROJECTS_CSV =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTXcA-PcMC_OCz4AuJcCRGTYbR1oEWeVljlgLzDDgiEtA853rNvveBFRtdGq5IbHatREp8TE6ptmX/pub?gid=146585938&single=true&output=csv";

    // =============================
    //  WRITE-BACK to Google Sheets (Apps Script Web App)
    // =============================
    const WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbyglN1rhEP0MjWlXik_F9-rcZSjAo3oscR9GySuDtgbNhhB2ZPd0mUmo3iCOl4L7--TJQ/exec";

    const SECRET =
      "b35bb77e-ad8f-4bd5-8642-94fd06c8ae8b-f431d4ea-6189-44f6-a29d-3820dbc7c4e9";

    function setLiveSnapshotLabel(text) {
      const el = document.getElementById("lastUpdateLabel");
      if (el) el.textContent = text;
    }

    function setApplyButtonState(isSaving) {
      const btn = document.getElementById("btnApplyChanges");
      if (!btn) return;
      btn.disabled = !!isSaving;
      btn.style.opacity = isSaving ? "0.6" : "1";
      btn.style.cursor = isSaving ? "not-allowed" : "pointer";
      btn.textContent = isSaving ? "Saving..." : "Apply locally";
    }

    async function writeBackProject(project) {
      const res = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ secret: SECRET, project })
      });

      const data = await res.json().catch(() => ({}));
      if (!data.ok) throw new Error(data.error || "Write-back failed");
      return data;
    }
 
    // =============================
    //  دوال مساعدة
    // =============================
 
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(",").map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(","); // القيم عندك أرقام / نص بسيط بلا فواصل داخلية
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = (cols[i] || "").trim();
        });
        return obj;
      });
    }
 
    function num(v) {
      if (v === undefined || v === null || v === "") return 0;
      return parseFloat(String(v).replace(/,/g, "")) || 0;
    }
 
    function formatInt(n) {
      return Math.round(n).toLocaleString("en-US");
    }
 
    function formatSar(n) {
      return formatInt(n) + " SAR";
    }
 
    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }
 
    // =============================
    //  تحميل البيانات ثم الرسم
    // =============================
    let data1Rows = [];
    let projects = [];
    let selectedProjectIndex = 0;
 
    function renderCashAndBudget() {
      if (!data1Rows.length) return;
 
      const rows = data1Rows;
      const nowRow = rows[0]; // نفترض أول صف هو الفترة الحالية
 
      const cashBalance = num(nowRow.Cash_Balance);
      const pending = num(nowRow.Pending_Payments);
      const obl30d = num(nowRow.Obligation_30D);
      const approvedBudget = num(nowRow.Budget_Total);
 
      // Actual YTD = مجموع Actual_Expense
      const actualYtd = rows.reduce((sum, r) => sum + num(r.Actual_Expense), 0);
 
      const budgetRemaining = Math.max(approvedBudget - actualYtd, 0);
 
      const totalMonths = rows.length || 1;
      const monthsWithActual = rows.filter(r => num(r.Actual_Expense) > 0).length;
      const expectedByNow =
        approvedBudget * (monthsWithActual / totalMonths || 0);
      const variance =
        expectedByNow > 0 ? ((actualYtd - expectedByNow) / expectedByNow) * 100 : 0;
 
      document.getElementById("cashBalanceValue").textContent =
        formatInt(cashBalance);
      document.getElementById("obl30dLabel").textContent =
        "Obligations 30D: " + formatSar(obl30d);
      document.getElementById("pendingLabel").textContent =
        "Pending: " + formatSar(pending);
 
      const cashStatusChip = document.getElementById("cashStatusChip");
      const ratio = obl30d > 0 ? cashBalance / obl30d : 999;
      if (ratio >= 2) {
        cashStatusChip.textContent = "Comfortable";
        cashStatusChip.classList.add("chip-green");
      } else if (ratio >= 1) {
        cashStatusChip.textContent = "Tight";
        cashStatusChip.classList.remove("chip-green");
        cashStatusChip.classList.add("chip-amber");
      } else {
        cashStatusChip.textContent = "Critical";
        cashStatusChip.classList.remove("chip-green", "chip-amber");
        cashStatusChip.classList.add("chip-red");
      }
 
      document.getElementById("budgetApproved").textContent =
        formatInt(approvedBudget);
      document.getElementById("budgetActual").textContent =
        formatInt(actualYtd);
      document.getElementById("budgetRemaining").textContent =
        formatInt(budgetRemaining);
 
      const variancePill = document.getElementById("budgetVariance");
      const vAbs = Math.abs(variance);
      const arrowSpan = variancePill.querySelector(".arrow");
      arrowSpan.textContent = variance >= 0 ? "▲" : "▼";
      variancePill.textContent = "";
      variancePill.appendChild(arrowSpan);
      variancePill.appendChild(
        document.createTextNode(
          " " + vAbs.toFixed(1) + "% " + (variance >= 0 ? "over plan" : "under plan")
        )
      );
 
      // لون الشيب حسب الانحراف
      const budgetChip = document.getElementById("budgetChip");
      budgetChip.classList.remove("chip-green", "chip-amber", "chip-red");
      if (vAbs <= 5) {
        budgetChip.textContent = "On track";
        budgetChip.classList.add("chip-green");
      } else if (vAbs <= 15) {
        budgetChip.textContent = "Monitoring";
        budgetChip.classList.add("chip-amber");
      } else {
        budgetChip.textContent = "Attention";
        budgetChip.classList.add("chip-red");
      }
 
      // Monthly cap: 25% من (budgetRemaining / remainingMonths) بحد أعلى 200k
      const remainingMonths = totalMonths - monthsWithActual || totalMonths;
      let suggestedCap =
        remainingMonths > 0
          ? (budgetRemaining / remainingMonths) * 0.25
          : budgetRemaining * 0.25;
      if (!isFinite(suggestedCap) || suggestedCap <= 0) suggestedCap = 200000;
      const hardCap = 200000;
      const cap = Math.min(hardCap, suggestedCap);
 
      document.getElementById("capValue").textContent = formatInt(cap);
      const capFill = document.getElementById("capBarFill");
      const capTick = document.getElementById("capBarTick");
      const pct = clamp((cap / hardCap) * 100, 0, 100);
      capFill.style.width = pct + "%";
      capTick.style.left = Math.min(pct + 5, 95) + "%";
 
      document.getElementById("capRuleText").textContent =
        "Rule: 25% of remaining budget / remaining months (max " +
        formatSar(hardCap) +
        ")";
 
      // Control status بسيط مبني على cash ratio و variance
      const controlChip = document.getElementById("controlChip");
      const controlText = document.getElementById("controlText");
      const controlDetails = document.getElementById("controlDetails");
 
      if (ratio >= 2 && vAbs <= 5) {
        controlChip.textContent = "Healthy";
        controlChip.className = "kpi-chip chip-green";
        controlText.textContent = "Under control";
        controlDetails.innerHTML =
          "• السيولة تغطي التزامات 30 يوم بهامش مريح<br/>" +
          "• الانحراف عن الميزانية ضمن النطاق المتفق عليه<br/>" +
          "• لا توجد تنبيهات حمراء في الأشهر الستة القادمة";
      } else if (ratio >= 1 && vAbs <= 15) {
        controlChip.textContent = "Watch";
        controlChip.className = "kpi-chip chip-amber";
        controlText.textContent = "Close monitoring";
        controlDetails.innerHTML =
          "• السيولة تغطي التزامات 30 يوم لكن بهامش محدود<br/>" +
          "• يوصى بمراجعة خطط الصرف للأشهر القادمة<br/>" +
          "• مخاطر متوسطة تحتاج متابعة أسبوعية";
      } else {
        controlChip.textContent = "Alert";
        controlChip.className = "kpi-chip chip-red";
        controlText.textContent = "Action required";
        controlDetails.innerHTML =
          "• السيولة أقل من الالتزامات قصيرة الأجل أو الانحراف كبير عن الخطة<br/>" +
          "• يجب مراجعة الالتزامات وخطة الصرف فوراً<br/>" +
          "• يوصى بررفع تقرير تفصيلي للمالك";
      }
 
      // تحديث نص "آخر تحديث" (كما هو)
      const firstMonth = nowRow.Month || "";
      if (!String(document.getElementById("lastUpdateLabel").textContent || "").includes("Saved")) {
        document.getElementById("lastUpdateLabel").textContent =
          "Live snapshot • latest row in Data1 (" + firstMonth + ")";
      }
    }

    function renderChart() {
      if (!data1Rows.length) return;

      const rows = data1Rows.slice(0, 6);
      const values = rows.map(r => num(r.Income_Forcast) - num(r.Expense_Forcast));
      const labels = rows.map(r => r.Month || "");

      const svg = document.getElementById("cashChart");
      svg.innerHTML = "";

      const width = 420;
      const height = 210;
      const leftPad = 28;
      const rightPad = 20;
      const topPad = 20;
      const bottomPad = 35;

      const xs = [];
      const ys = [];

      const maxVal = Math.max(...values, 0) || 1;
      const minVal = Math.min(...values, 0);
      const span = maxVal - minVal || 1;

      values.forEach((v, i) => {
        const x =
          leftPad +
          (i / Math.max(values.length - 1, 1)) * (width - leftPad - rightPad);
        const norm = (v - minVal) / span;
        const y = topPad + (1 - norm) * (height - topPad - bottomPad);
        xs.push(x);
        ys.push(y);
      });

      const safeY =
        topPad +
        (1 - (0 - minVal) / span) * (height - topPad - bottomPad);

      const safeLine = document.createElementNS("http://www.w3.org/2000/svg","line");
      safeLine.setAttribute("x1", leftPad);
      safeLine.setAttribute("y1", safeY);
      safeLine.setAttribute("x2", width - rightPad);
      safeLine.setAttribute("y2", safeY);
      safeLine.setAttribute("stroke", "#c5a56c");
      safeLine.setAttribute("stroke-width", "1.4");
      safeLine.setAttribute("stroke-dasharray", "4 5");
      svg.appendChild(safeLine);

      const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
      const grad = document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
      grad.setAttribute("id", "cfLine");
      grad.setAttribute("x1", "0");
      grad.setAttribute("x2", "1");
      grad.setAttribute("y1", "0");
      grad.setAttribute("y2", "0");
      const stop1 = document.createElementNS("http://www.w3.org/2000/svg","stop");
      stop1.setAttribute("offset", "0%");
      stop1.setAttribute("stop-color", "#54d3d4");
      const stop2 = document.createElementNS("http://www.w3.org/2000/svg","stop");
      stop2.setAttribute("offset", "100%");
      stop2.setAttribute("stop-color", "#11c5c6");
      grad.appendChild(stop1);
      grad.appendChild(stop2);
      defs.appendChild(grad);
      svg.appendChild(defs);

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      let d = "";
      xs.forEach((x, i) => { d += (i === 0 ? "M" : "L") + x + " " + ys[i] + " "; });
      path.setAttribute("d", d);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "url(#cfLine)");
      path.setAttribute("stroke-width", "3");
      path.setAttribute("stroke-linecap", "round");
      path.setAttribute("stroke-linejoin", "round");
      svg.appendChild(path);

      values.forEach((v, i) => {
        const cx = xs[i], cy = ys[i];
        const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circle.setAttribute("cx", cx);
        circle.setAttribute("cy", cy);
        circle.setAttribute("r", "4.3");
        circle.setAttribute("fill", "#54d3d4");
        circle.setAttribute("stroke", "#011015");
        circle.setAttribute("stroke-width", "1.4");
        svg.appendChild(circle);

        const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute("x", cx);
        txt.setAttribute("y", cy - 8);
        txt.setAttribute("text-anchor", "middle");
        txt.setAttribute("fill", "#e7fcff");
        txt.setAttribute("font-size", "9");
        txt.textContent = formatInt(v);
        svg.appendChild(txt);
      });

      labels.forEach((label, i) => {
        const tx = xs[i];
        const ty = height - 12;
        const text = document.createElementNS("http://www.w3.org/2000/svg","text");
        text.setAttribute("x", tx);
        text.setAttribute("y", ty);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#9fb4c0");
        text.setAttribute("font-size", "10");
        text.textContent = label || "";
        svg.appendChild(text);
      });

      const maxIndex = values.indexOf(Math.max(...values));
      const bestMonth = labels[maxIndex] || "";
      document.getElementById("chartComment").innerHTML =
        "<strong>تحليل مختصر:</strong> أعلى صافي تدفقات متوقعة في " +
        (bestMonth || "إحدى الأشهر") +
        "، ويمكن تعديل سياسة الصرف إذا اقترب الخط من الحد الأدنى الآمن.";
    }

    function mapRiskLevelToColor(level) {
      const lv = (level || "").toLowerCase();
      if (lv === "high") return "red";
      if (lv === "medium") return "yellow";
      if (lv === "low") return "green";
      return null;
    }

    function buildProjectRow(project) {
      const actual = num(project.Actual_Progress);
      const planned = num(project.Planned_Progress);
      const primaryRiskLevel = project.Risk1_level || "";
      const primaryRiskNote = project.Risk1_Note || "";
      const secondaryRiskLevel = project.Risk2_level || "";
      const secondaryRiskNote = project.Risk2_Note || "";

      const primaryColor = mapRiskLevelToColor(primaryRiskLevel) || "red";
      const secondaryColor = mapRiskLevelToColor(secondaryRiskLevel) || "yellow";

      const barWidth = clamp(actual, 0, 100);
      const tickPos = clamp(planned, 0, 100);

      const riskChips = [];

      if (primaryRiskLevel || primaryRiskNote) {
        riskChips.push(`
          <div class="risk-chip">
            <span class="risk-dot ${primaryColor}"></span>
            ${primaryRiskLevel ? primaryRiskLevel + " – " : ""}${primaryRiskNote}
          </div>
        `);
      }

      if (secondaryRiskLevel || secondaryRiskNote) {
        riskChips.push(`
          <div class="risk-chip">
            <span class="risk-dot ${secondaryColor}"></span>
            ${secondaryRiskLevel ? secondaryRiskLevel + " – " : ""}${secondaryRiskNote}
          </div>
        `);
      }

      return `
        <div class="project-row">
          <div class="project-top">
            <div>
              <div class="project-name">${project.Project_Name || ""}</div>
              <div class="project-meta">
                <span>${project.Stage_text || ""}</span>
                <span>Start: ${project.Start_Date || ""}</span>
                <span>Duration: ${project.Planned_Duration || ""} days</span>
              </div>
            </div>
            <div class="project-badges">
              <span class="badge-stage">
                ${actual >= planned ? "On plan" : "Behind plan"}
              </span>
            </div>
          </div>

          <div class="progress-shell">
            <div class="progress-labels">Progress</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${barWidth}%;"></div>
              <div class="progress-tick" style="left:${tickPos}%;"></div>
            </div>
            <div class="progress-percent">
              ${actual.toFixed(0)}% / ${planned.toFixed(0)}%
            </div>
          </div>

          <div class="risk-chips">
            ${riskChips.join("")}
          </div>
        </div>
      `;
    }

    function renderProjects() {
      if (!projects.length) return;

      const mainIndex = selectedProjectIndex % projects.length;
      const secondIndex = (mainIndex + 1) % projects.length;

      const mainProject = projects[mainIndex];
      const secondProject = projects.length > 1 ? projects[secondIndex] : null;

      const container = document.getElementById("projectsContainer");
      let html = buildProjectRow(mainProject);
      if (secondProject) html += buildProjectRow(secondProject);
      container.innerHTML = html;

      document.getElementById("projectFilterName").textContent =
        mainProject.Project_Name || "—";
      document.getElementById("projectFilterMeta").textContent =
        "Project ID: " + (mainProject.Project_ID || "");

      const select = document.getElementById("adminProjectSelect");
      select.innerHTML = projects
        .map((p, idx) =>
          `<option value="${idx}" ${idx === mainIndex ? "selected" : ""}>${p.Project_ID || ""} — ${p.Project_Name || ""}</option>`
        )
        .join("");

      fillAdminForm(mainProject);
    }

    function fillAdminForm(project) {
      if (!project) return;
      document.getElementById("adminName").value = project.Project_Name || "";
      document.getElementById("adminStage").value = project.Stage_text || "";
      document.getElementById("adminStart").value = project.Start_Date || "";
      document.getElementById("adminDuration").value = project.Planned_Duration || "";
      document.getElementById("adminActual").value = project.Actual_Progress || "";
      document.getElementById("adminPlanned").value = project.Planned_Progress || "";
      document.getElementById("adminRisk1Level").value = project.Risk1_level || "";
      document.getElementById("adminRisk1Note").value = project.Risk1_Note || "";
      document.getElementById("adminRisk2Level").value = project.Risk2_level || "";
      document.getElementById("adminRisk2Note").value = project.Risk2_Note || "";
    }

    function applyAdminChanges() {
      if (!projects.length) return;
      const idx = selectedProjectIndex;
      const p = projects[idx];

      p.Project_Name = document.getElementById("adminName").value;
      p.Stage_text = document.getElementById("adminStage").value;
      p.Start_Date = document.getElementById("adminStart").value;
      p.Planned_Duration = document.getElementById("adminDuration").value;
      p.Actual_Progress = document.getElementById("adminActual").value;
      p.Planned_Progress = document.getElementById("adminPlanned").value;
      p.Risk1_level = document.getElementById("adminRisk1Level").value;
      p.Risk1_Note = document.getElementById("adminRisk1Note").value;
      p.Risk2_level = document.getElementById("adminRisk2Level").value;
      p.Risk2_Note = document.getElementById("adminRisk2Note").value;

      renderProjects();
    }

    document.addEventListener("DOMContentLoaded", () => {
      Promise.all([
        fetch(DATA1_CSV).then(r => r.text()),
        fetch(PROJECTS_CSV).then(r => r.text())
      ])
        .then(([data1Text, projectsText]) => {
          data1Rows = parseCSV(data1Text);
          projects = parseCSV(projectsText);
          projects = projects.filter(p => p.Project_Name || p.Project_ID);

          renderCashAndBudget();
          renderChart();
          renderProjects();
        })
        .catch(err => {
          console.error("Error loading CSV:", err);
        });

      document.getElementById("adminProjectSelect").addEventListener("change", e => {
        selectedProjectIndex = parseInt(e.target.value, 10) || 0;
        renderProjects();
      });

      // ✅ Apply locally + Write-back to Sheets
      document.getElementById("btnApplyChanges").addEventListener("click", async (e) => {
        e.preventDefault();

        // 1) Apply locally (كما كان)
        applyAdminChanges();

        // 2) Write-back إلى Google Sheets
        try {
          setApplyButtonState(true);
          setLiveSnapshotLabel("Saving project to Sheets…");

          const project = projects[selectedProjectIndex];
          const result = await writeBackProject(project);

          const pid = (project && project.Project_ID) ? project.Project_ID : "—";
          setLiveSnapshotLabel("Saved ✔︎ • Project " + pid + " • Sheets updated");
          console.log("Write-back OK:", result);
        } catch (err) {
          console.error("Write-back failed:", err);
          setLiveSnapshotLabel("Save failed ✖︎ • Check Apps Script permissions / WebApp");
          alert("Save to Sheets failed:\n" + (err && err.message ? err.message : err));
        } finally {
          setApplyButtonState(false);
        }
      });
    });
  </script>
</body>
</html>
